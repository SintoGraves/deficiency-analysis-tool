<!-- ============================================================
  File: /docs/opcon-demo.html
  Operational Consideration Builder (Demo) — Self-Contained
  --------------------------------------------------------------------
  PURPOSE (Demo):
    - Operator-level Operational Consideration (OPCON) template builder.
    - Guidance text is shown first (pink italics + black example context).
    - Preview does NOT change while typing.
    - When user clicks "Generate Preview", guidance disappears and user input replaces it.
    - Save to DOCX exports Word-compatible HTML (.doc) for POC.

  EXAMPLE SYSTEM UNDER TEST (Demo):
    - Office Copier / Printer / Scanner (MFD)
    - SoS 1: Network environment
    - SoS 2: Direct USB-connected workstation
============================================================ -->

<!-- ============================================================
  File: /docs/opcon-demo.html
  Operational Consideration Builder (Demo) — Self-Contained
  --------------------------------------------------------------------
  UPDATE IN THIS VERSION:
    - Adds Risk Matrix (5x5) tied to Paragraph 5 (Likelihood of Recurrence)
      * Likelihood is computed from # runs observed + # runs with issue (1–5)
      * Consequence is selected (1–5) using operator-impact descriptors
      * Risk band computed as High / Medium / Low; only selected cell colored
    - Adds Primary COI and Other COI in Paragraph 1 as subitems a. and b.
    - Assigns tense per paragraph + advisory checks for each paragraph

  EXAMPLE SYSTEM UNDER TEST (Demo):
    - Office Copier / Printer / Scanner (MFD)
    - SoS 1: Network environment
    - SoS 2: Direct USB-connected workstation
============================================================ -->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OPCON Builder (Demo)</title>

  <style>
    :root{
      --border: rgba(0,0,0,.14);
      --muted: rgba(0,0,0,.65);
      --ink: #111;
      --guidance: #FF33CC; /* RGB(255,51,204) */
      --gridline: rgba(0,0,0,.35);

      /* Risk colors (selected cell only) */
      --risk-low:  #2f7a3e;   /* green-ish */
      --risk-med:  #c79100;   /* yellow-ish */
      --risk-high: #a21724;   /* red-ish */

      /* Print geometry (8.5 x 11 feel) */
      --page-w: 8.5in;
      --page-h: 11in;
      --margin: 1in;
      --usable-w: 6.5in;

      /* Risk cube sizing */
      --risk-w: 3.0in;

      /* UI layout */
      --ui-max: 1180px;

      /* Status colors (Advisory checks) */
      --ok: #2f7a3e;
      --warn: #c79100;
      --bad: #a21724;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      color: var(--ink);
      background: #fff;
    }

    header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }
    .header-left{ flex: 1 1 auto; min-width: 0; }
    .header-right{ flex: 0 0 auto; padding-top: 2px; }

    header h1 { margin: 0 0 6px; font-size: 18px; }
    header p  { margin: 0; color: var(--muted); font-size: 13px; line-height: 1.35; }

    .btn-link{
      border: 1px solid var(--border);
      background: #f7f7f7;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .wrap { max-width: var(--ui-max); margin: 0 auto; padding: 16px 18px; }
    .grid { display: grid; grid-template-columns: 460px 1fr; gap: 14px; align-items: start; }
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
      header{ position: static; }
    }

    .card { border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: #fff; }
    .card h2 { margin: 0; font-size: 14px; }
    .hr { border-top: 1px solid var(--border); margin: 12px 0; }

    label { display: block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    input, select, textarea {
      width: 100%; box-sizing: border-box;
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px; font-size: 13px; background: #fff;
    }
    textarea { min-height: 86px; resize: vertical; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btnbar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

    button {
      border: 1px solid var(--border);
      background: #f7f7f7; border-radius: 10px;
      padding: 10px 12px; font-size: 13px; cursor: pointer;
    }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 8px; background: #fafafa; }

    .guidance {
      font-style: italic;
      color: var(--guidance);
      font-size: 12.5px;
      line-height: 1.35;
      margin: 6px 0 8px;
    }
    .context {
      font-size: 12.5px;
      line-height: 1.35;
      color: rgba(0,0,0,.78);
      margin: 6px 0 10px;
    }

    .modebar {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px dashed rgba(0,0,0,.18);
      border-radius: 12px;
      background: #fbfbfb;
      margin-bottom: 10px;
      font-size: 12.5px;
      color: rgba(0,0,0,.75);
      line-height: 1.35;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
    }

    .preview { font-family: "Times New Roman", Times, serif; }
    .paper {
      width: min(100%, var(--page-w));
      margin: 0 auto;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .paper-inner{ padding: var(--margin); }

    .topline { text-align: center; font-weight: 700; }
    .subline { text-align: center; margin-top: 2px; }
    .meta { display:flex; justify-content: space-between; margin: 10px 0 14px; font-size: 12px; }
    .sect { margin: 12px 0; max-width: var(--usable-w); }
    .sect h3 { margin: 0 0 6px; font-size: 14px; }
    .sect p  { margin: 0 0 8px; font-size: 13px; line-height: 1.35; }
    .mini { font-size: 12px; margin-top: 6px; line-height: 1.35; }
    .muted { color: rgba(0,0,0,.65); }

    /* Risk matrix (after Paragraph 5) */
    .risk-wrap{ margin-top: 10px; max-width: var(--usable-w); }
    .risk-title{ font-size: 12.5px; margin: 6px 0 8px; line-height: 1.25; }
    .risk-center{ display:flex; justify-content:center; }
    .risk-cube{
      width: var(--risk-w);
      border: 1px solid var(--gridline);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    .risk-grid{
      display:grid;
      grid-template-columns: 44px repeat(5, 1fr);
      grid-template-rows: 34px repeat(5, 1fr);
    }
    .risk-cell{
      border-right: 1px solid var(--gridline);
      border-bottom: 1px solid var(--gridline);
      padding: 6px 6px;
      font-size: 10.5px;
      line-height: 1.15;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:#fff;
      min-height: 34px;
    }
    .risk-cell.head{
      font-size: 10px;
      color: rgba(0,0,0,.75);
      background: #f7f7f7;
      font-weight: 600;
    }
    .risk-cell.axis{
      background: #f7f7f7;
      font-weight: 600;
      color: rgba(0,0,0,.75);
    }
    .risk-selected.low  { background: rgba(47,122,62,.18); outline: 2px solid rgba(47,122,62,.6); }
    .risk-selected.med  { background: rgba(199,145,0,.20); outline: 2px solid rgba(199,145,0,.65); }
    .risk-selected.high { background: rgba(162,23,36,.16); outline: 2px solid rgba(162,23,36,.65); }
    .risk-selected .tag { font-weight: 700; }

    .checks{
      margin-top: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fafafa;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(0,0,0,.75);
    }
    .checkline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .checkline:last-child{ border-bottom: none; }
    .status{ font-weight: 700; white-space: nowrap; }
    .ok{ color: var(--ok); }
    .warn{ color: var(--warn); }
    .bad{ color: var(--bad); }

    @media print {
      header, .left, .btnbar { display: none !important; }
      .wrap { padding: 0; }
      .card { border: none; }
      .paper{ border:none; border-radius:0; }
      body { margin: 0; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-row">
      <div class="header-left">
        <h1>OPCON Builder (Demo)</h1>
        <p>
          Guidance is shown first (pink italics) and remains visible while you type.
          Select <span class="kbd">Generate Preview</span> to replace guidance with your entered content.
        </p>
      </div>
      <div class="header-right">
        <button id="btnBack" class="btn-link" type="button">Back</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT: INPUTS -->
      <div class="card left">
        <h2>Inputs</h2>

        <div class="hr"></div>
        <div class="row">
          <div>
            <label for="refId">Reference ID (optional)</label>
            <input id="refId" placeholder="OPCON-DEMO-001" />
          </div>
          <div>
            <label for="date">Date (DD Mmm YYYY)</label>
            <input id="date" placeholder="31 Dec 2025" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="sutName">SUT name</label>
          <input id="sutName" placeholder="Office Copier / Printer / Scanner (MFD)" />
          <div class="hint">
            Demo SUT supports SoS 1 (Network) and SoS 2 (USB direct-connected workstation).
          </div>
        </div>

        <div class="hr"></div>

        <!-- COI fields (Para 1 a/b) -->
        <div class="row">
          <div>
            <label for="coiPrimary">Primary COI</label>
            <input id="coiPrimary" placeholder="S-7, Training / Supportability" />
          </div>
          <div>
            <label for="coiOther">Other COI(s)</label>
            <input id="coiOther" placeholder="C-3, Network Integration" />
          </div>
        </div>

        <!-- Risk inputs (tied to Para 5) -->
        <div class="hr"></div>
        <div>
          <label>Risk characterization (ties to Paragraph 5)</label>
          <div class="hint">
            Likelihood is computed from observed runs. Consequence is selected based on operational interference.
          </div>
        </div>

        <div class="row3" style="margin-top:10px;">
          <div>
            <label for="runsTotal">Total runs observed</label>
            <select id="runsTotal">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5" selected>5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
          </div>
          <div>
            <label for="runsIssue">Runs with issue observed</label>
            <select id="runsIssue">
              <option value="0">0</option>
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
          </div>
          <div>
            <label for="consequenceLevel">Consequence (1–5)</label>
            <select id="consequenceLevel">
              <option value="1">1 — Low (quick mitigation)</option>
              <option value="2">2 — Low/Med (annoying, manageable)</option>
              <option value="3" selected>3 — Medium (operators complain; benefits outweigh trouble)</option>
              <option value="4">4 — Med/High (significant interference)</option>
              <option value="5">5 — High (operators avoid using it)</option>
            </select>
          </div>
        </div>

        <div class="hint" id="likelihoodSummary" style="margin-top:8px;"></div>

        <div class="hr"></div>

        <div class="hint">
          Inputs are intentionally blank for the demo. Guidance and example text remain on the right until you generate.
        </div>

        <!-- Tense assignments (OPCON) -->
        <div style="margin-top:10px;">
          <label for="p1">1. Observed Operational Problem (past tense)</label>
          <textarea id="p1" spellcheck="true" placeholder=""></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="p2">2. Conditions, Events, and Analysis (past tense)</label>
          <textarea id="p2" spellcheck="true" placeholder=""></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="p3">3. Mission Impact (present tense)</label>
          <textarea id="p3" spellcheck="true" placeholder=""></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="p4">4. Operational Recommendation (present tense, imperative “should”)</label>
          <textarea id="p4" spellcheck="true" placeholder=""></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="p5">5. Likelihood of Recurrence (present tense; align with risk)</label>
          <textarea id="p5" spellcheck="true" placeholder=""></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="p6">6. Recommendation (present tense)</label>
          <textarea id="p6" spellcheck="true" placeholder=""></textarea>
        </div>

        <div class="btnbar">
          <button class="primary" id="btnGenerate" type="button">Generate Preview</button>
          <button id="btnReset" type="button">Reset</button>
          <button id="btnSave" type="button">Save to DOCX</button>
        </div>

        <div class="hint">
          Demo logic: typing does not modify the preview. Only <span class="kbd">Generate Preview</span> replaces guidance with inputs.
        </div>

        <div class="checks" id="checksPanel" aria-label="Advisory checks">
          <div style="font-weight:700; margin-bottom:6px;">Advisory Checks (Tense + Completeness)</div>
          <div class="checkline"><span>Para 1: past tense</span><span id="chk1" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Para 2: past tense</span><span id="chk2" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Para 3: present tense</span><span id="chk3" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Para 4: actionable “should”</span><span id="chk4" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Para 5: present tense + aligns with observed likelihood</span><span id="chk5" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Para 6: present tense</span><span id="chk6" class="status warn">CHECK</span></div>
        </div>
      </div>

      <!-- RIGHT: PREVIEW -->
      <div class="card preview">
        <div class="modebar">
          <div>
            <span class="badge" id="modeBadge">DRAFT (Guidance Visible)</span>
            <span id="riskNote" class="muted" style="margin-left:8px;"></span>
          </div>
          <div class="muted">Risk matrix appears after Paragraph 5.</div>
        </div>

        <div class="paper">
          <div class="paper-inner" id="previewHost"></div>
        </div>

        <div class="hint muted" style="margin-top:10px;">
          Note: “Save to DOCX” exports Word-compatible HTML (.doc) for demo purposes.
        </div>
      </div>

    </div>
  </div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);

    let generatedMode = false;

    /* ---------------- Guidance content (Office MFD demo) ---------------- */
    const GUIDANCE = {
      sutName: "Office Copier / Printer / Scanner (MFD) — SoS 1: Network | SoS 2: USB-connected workstation",
      coiPrimary: "S-7, Training / Supportability",
      coiOther: "C-3, Network Integration",
      p1: {
        g:
`Paragraph 1 — Observed Operational Problem (past tense).
State the specific operator-observed problem in clear operator terms. Keep it concise and unambiguous.`,
        x:
"The MFD intermittently failed to complete Scan-to-Network jobs to approved network destinations during routine office operations."
      },
      p2: {
        g:
`Paragraph 2 — Conditions, Events, and Analysis (past tense).
Describe the conditions where the problem occurred (network SoS vs USB SoS), what the operator did, what the system did, and why.`,
        x:
`The MFD’s ability to print from a networked PC, scan to approved network destinations, scan to a USB-connected workstation, and copy was assessed during routine office operations over five days using standard user accounts and approved network shares. During this period, the MFD intermittently failed to complete Scan-to-Network jobs while Print-from-PC, Scan-to-PC, and Copy functions operated normally.\n\nScan-to-Network failures occurred in 9 of 50 scan attempts and terminated with an on-panel error message and no file written to the destination share. In 6 of the 9 failures, repeating the same job without changing settings resulted in successful completion. As a workaround, users performed Scan-to-PC via USB connection and manually transferred files to the network, increasing steps and time to completion.\n\nThe data indicated Scan-to-Network reliability was inconsistent under normal operational load. The workaround increased user workload and introduced additional opportunities for error.`
      },
      p3: {
        g:
`Paragraph 3 — Mission Impact (present tense).
Explain how the issue affects the operator’s ability to accomplish the work (workload, timing, errors, lost products).`,
        x:
"Intermittent Scan-to-Network failures delay dissemination of scanned products, increase rework, and reduce confidence that scanned documents are reliably captured and shared."
      },
      p4: {
        g:
`Paragraph 4 — Operational Recommendation (present tense; SOP-ready; use “should”).
Provide clear, actionable steps operators can implement immediately.`,
        x:
"Operators should reattempt a failed Scan-to-Network job once without modifying settings. If the job fails a second time, operators should perform Scan-to-PC via USB and manually transfer the file to the approved network destination, documenting the occurrence and time of failure for troubleshooting."
      },
      p5: {
        g:
`Paragraph 5 — Likelihood of Recurrence (present tense).
Tie this paragraph to observed frequency (runs) and consequence. State whether recurrence is likely, and under what conditions.`,
        x:
"This issue is likely to recur during routine network operations when multiple users are submitting scan jobs to shared destinations."
      },
      p6: {
        g:
`Paragraph 6 — Recommendation (present tense).
State whether to adopt as SOP, include in training, and/or publish as local operating instruction.`,
        x:
"Adopt this procedure as standard operator practice and incorporate it into local operating instructions and training for routine MFD scanning operations."
      }
    };

    /* ---------------- Inputs list ---------------- */
    const fields = [
      "refId","date","sutName","coiPrimary","coiOther",
      "runsTotal","runsIssue","consequenceLevel",
      "p1","p2","p3","p4","p5","p6"
    ];

    function getForm(){
      const d = {};
      fields.forEach(k => d[k] = ($(k)?.value || "").trim());
      return d;
    }

    function esc(s){
      return (s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    function para(text){
      const parts = (text || "").split(/\n\s*\n/).map(t => t.trim()).filter(Boolean);
      return parts.map(p => `<p>${esc(p)}</p>`).join("");
    }

    function guidanceBlock(g, x){
      return `
        <div class="guidance">${esc(g)}</div>
        <div class="context">${para(x)}</div>
      `;
    }

    /* ============================================================
       RISK MODEL (5x5) — derived from runs + consequence selection
       Likelihood (1–5) rules (based on percent of runs with issue):
         - 5: >= 0.90 (near every time)
         - 4: >= 0.70
         - 3: >= 0.40 (~50% lives here)
         - 2: >= 0.15
         - 1: >  0.00 (observed once or twice)
         - 0: 0.00 => treat as 1 (not expected in practice)
       Consequence is selected 1–5.
       Risk band mapping uses product thresholds (POC):
         - 1–6  => Low
         - 7–14 => Medium
         - 15–25 => High
       ============================================================ */
    function clampInt(n, lo, hi){
      const x = parseInt(String(n || "0"), 10);
      if (isNaN(x)) return lo;
      return Math.max(lo, Math.min(hi, x));
    }

    function likelihoodFromRuns(totalRuns, issueRuns){
      const t = Math.max(1, clampInt(totalRuns, 1, 10));
      const i = Math.max(0, clampInt(issueRuns, 0, 10));
      const ratio = Math.min(1, i / t);

      if (ratio >= 0.90) return { level: 5, label: "High (near every time)", ratio };
      if (ratio >= 0.70) return { level: 4, label: "Med/High (frequent)", ratio };
      if (ratio >= 0.40) return { level: 3, label: "Moderate (~about half)", ratio };
      if (ratio >= 0.15) return { level: 2, label: "Low/Mod (occasional)", ratio };
      if (ratio > 0.00)  return { level: 1, label: "Low (observed once or twice)", ratio };
      return { level: 1, label: "Low (no occurrences entered)", ratio };
    }

    function riskBandFromCL(c, l){
      const v = c * l;
      if (v <= 6) return "Low";
      if (v <= 14) return "Medium";
      return "High";
    }

    function riskClassFromBand(band){
      if (band === "Low") return "low";
      if (band === "Medium") return "med";
      return "high";
    }

    function renderRiskMatrix(c, l, band, tag, figureNumber){
      const cls = riskClassFromBand(band);
      const title = `Figure ${figureNumber}. Issue Risk Matrix (${band} Risk) — Selected: C${c} x L${l}`;

      let html = `
        <div class="risk-wrap">
          <div class="risk-title"><strong>${esc(title)}</strong></div>
          <div class="risk-center">
            <div class="risk-cube" role="img" aria-label="Risk matrix">
              <div class="risk-grid">
      `;

      html += `<div class="risk-cell head"></div>`;
      for (let cx = 1; cx <= 5; cx++) html += `<div class="risk-cell head">C${cx}</div>`;

      for (let ly = 5; ly >= 1; ly--) {
        html += `<div class="risk-cell axis">L${ly}</div>`;
        for (let cx = 1; cx <= 5; cx++) {
          const isSel = (cx === c && ly === l);
          const selClass = isSel ? `risk-selected ${cls}` : "";
          const cellText = isSel ? `<span class="tag">${esc(tag)}</span>` : "";
          html += `<div class="risk-cell ${selClass}">${cellText}</div>`;
        }
      }

      html += `
              </div>
            </div>
          </div>
          <div class="mini muted">
            <div><strong>Likelihood</strong> is computed from observed runs. <strong>Consequence</strong> is selected based on operational interference.</div>
          </div>
        </div>
      `;
      return html;
    }

    function updateLikelihoodSummary(){
      const d = getForm();
      const total = clampInt(d.runsTotal, 1, 10);
      const issue = clampInt(d.runsIssue, 0, 10);
      const L = likelihoodFromRuns(total, issue);
      const msg = `Computed Likelihood: L${L.level} — ${L.label} (${issue}/${total} runs; ${(L.ratio*100).toFixed(0)}%).`;
      const el = $("likelihoodSummary");
      if (el) el.textContent = msg;

      const note = $("riskNote");
      if (note) {
        const c = clampInt(d.consequenceLevel, 1, 5);
        const band = riskBandFromCL(c, L.level);
        note.textContent = `Risk: ${band} (C${c} x L${L.level}).`;
      }
    }

    /* ---------------- Advisory checks (tense heuristics) ---------------- */
    function setCheck(id, level, label){
      const el = $(id);
      if (!el) return;
      el.classList.remove("ok","warn","bad");
      el.classList.add(level);
      el.textContent = label;
    }

    function looksPastTense(s){
      const t = (s || "").toLowerCase();
      if (!t) return false;
      return /(\bwas\b|\bwere\b|\bexperienced\b|\bfailed\b|\boccurred\b|\bresulted\b|\bassessed\b|\bobserved\b|\brequired\b|\bterminated\b)/.test(t)
        || /\b\w+ed\b/.test(t);
    }

    function looksPresentTense(s){
      const t = (s || "").toLowerCase();
      if (!t) return false;
      return /(\bis\b|\bare\b|\bhas\b|\bhave\b|\bdelays\b|\bincreases\b|\breduces\b|\bindicates\b|\bremains\b)/.test(t);
    }

    function hasShould(s){
      const t = (s || "").toLowerCase();
      if (!t) return false;
      return /\bshould\b/.test(t);
    }

    function para5MentionsLikelihood(s){
      const t = (s || "").toLowerCase();
      if (!t) return false;
      return /\blikely\b|\bunlikely\b|\boccasional\b|\bfreq(uent|uently)\b|\brare\b|\brecurr(en|ence)\b|\bexpected\b/.test(t);
    }

    function runChecks(){
      const d = getForm();

      // P1 past
      if (!d.p1) setCheck("chk1","warn","EMPTY");
      else if (looksPastTense(d.p1)) setCheck("chk1","ok","OK");
      else setCheck("chk1","warn","REVIEW");

      // P2 past
      if (!d.p2) setCheck("chk2","warn","EMPTY");
      else if (looksPastTense(d.p2)) setCheck("chk2","ok","OK");
      else setCheck("chk2","warn","REVIEW");

      // P3 present
      if (!d.p3) setCheck("chk3","warn","EMPTY");
      else if (looksPresentTense(d.p3)) setCheck("chk3","ok","OK");
      else setCheck("chk3","warn","REVIEW");

      // P4 should/actionable
      if (!d.p4) setCheck("chk4","warn","EMPTY");
      else if (hasShould(d.p4)) setCheck("chk4","ok","OK");
      else setCheck("chk4","bad","ADD “SHOULD”");

      // P5 present + likelihood alignment
      if (!d.p5) setCheck("chk5","warn","EMPTY");
      else {
        const present = looksPresentTense(d.p5) || /\bwill\b/i.test(d.p5) === false; // softer
        const mentions = para5MentionsLikelihood(d.p5);
        if (present && mentions) setCheck("chk5","ok","OK");
        else if (mentions) setCheck("chk5","warn","ADD PRESENT");
        else setCheck("chk5","bad","ADD LIKELIHOOD");
      }

      // P6 present
      if (!d.p6) setCheck("chk6","warn","EMPTY");
      else if (looksPresentTense(d.p6) || hasShould(d.p6)) setCheck("chk6","ok","OK");
      else setCheck("chk6","warn","REVIEW");
    }

    /* ---------------- Preview renderer ---------------- */
    function renderPreviewHtml(){
      const d = getForm();

      const refId = esc(d.refId || "OPCON-DEMO-XXX");
      const date = esc(d.date || "DD Mmm YYYY");

      const sutLine = generatedMode
        ? esc(d.sutName || GUIDANCE.sutName)
        : esc(GUIDANCE.sutName);

      const coiPrimary = esc(d.coiPrimary || GUIDANCE.coiPrimary);
      const coiOther   = esc(d.coiOther || GUIDANCE.coiOther);

      // Risk derived values
      const total = clampInt(d.runsTotal, 1, 10);
      const issue = clampInt(d.runsIssue, 0, 10);
      const L = likelihoodFromRuns(total, issue);
      const C = clampInt(d.consequenceLevel, 1, 5);
      const band = riskBandFromCL(C, L.level);

      const tag = `OPCON-${esc(String(C))}${esc(String(L.level))}`; // short tag for cell label
      const riskMatrix = renderRiskMatrix(C, L.level, band, tag, 1);

      const p1 = generatedMode
        ? (d.p1 ? para(d.p1) : `<p class="muted">[Paragraph 1 not entered]</p>`)
        : guidanceBlock(GUIDANCE.p1.g, GUIDANCE.p1.x);

      const p2 = generatedMode
        ? (d.p2 ? para(d.p2) : `<p class="muted">[Paragraph 2 not entered]</p>`)
        : guidanceBlock(GUIDANCE.p2.g, GUIDANCE.p2.x);

      const p3 = generatedMode
        ? (d.p3 ? para(d.p3) : `<p class="muted">[Paragraph 3 not entered]</p>`)
        : guidanceBlock(GUIDANCE.p3.g, GUIDANCE.p3.x);

      const p4 = generatedMode
        ? (d.p4 ? para(d.p4) : `<p class="muted">[Paragraph 4 not entered]</p>`)
        : guidanceBlock(GUIDANCE.p4.g, GUIDANCE.p4.x);

      const p5 = generatedMode
        ? (d.p5 ? para(d.p5) : `<p class="muted">[Paragraph 5 not entered]</p>`)
        : guidanceBlock(GUIDANCE.p5.g, GUIDANCE.p5.x);

      const p6 = generatedMode
        ? (d.p6 ? para(d.p6) : `<p class="muted">[Paragraph 6 not entered]</p>`)
        : guidanceBlock(GUIDANCE.p6.g, GUIDANCE.p6.x);

      const likelihoodLine = `Observed Likelihood: L${L.level} — ${esc(L.label)} (${issue}/${total} runs; ${(L.ratio*100).toFixed(0)}%).`;
      const consequenceLine = `Selected Consequence: C${C}. Computed Risk: ${band} (C${C} x L${L.level}).`;

      return `
        <div class="topline">DRAFT</div>
        <div class="subline"><strong>OPERATIONAL CONSIDERATION (OPCON)</strong></div>
        <div class="subline"><strong>REFERENCE:</strong> ${refId}</div>

        <div class="meta">
          <div><span class="muted">Date:</span> ${date}</div>
          <div><span class="muted">SUT:</span> ${sutLine}</div>
        </div>

        <div class="sect">
          <h3>1. OBSERVED OPERATIONAL PROBLEM.</h3>
          ${p1}
          <div class="mini">
            <div><span class="muted">a. Primary COI:</span> ${coiPrimary}</div>
            <div><span class="muted">b. Other COI(s):</span> ${coiOther}</div>
          </div>
        </div>

        <div class="sect">
          <h3>2. CONDITIONS, EVENTS, AND ANALYSIS.</h3>
          ${p2}
        </div>

        <div class="sect">
          <h3>3. MISSION IMPACT.</h3>
          ${p3}
        </div>

        <div class="sect">
          <h3>4. OPERATIONAL RECOMMENDATION.</h3>
          ${p4}
        </div>

        <div class="sect">
          <h3>5. LIKELIHOOD OF RECURRENCE.</h3>
          ${p5}
          <div class="mini muted">
            <div><strong>${esc(likelihoodLine)}</strong></div>
            <div>${esc(consequenceLine)}</div>
          </div>
          ${riskMatrix}
        </div>

        <div class="sect">
          <h3>6. RECOMMENDATION.</h3>
          ${p6}
        </div>
      `;
    }

    function setMode(isGenerated){
      generatedMode = !!isGenerated;
      const badge = $("modeBadge");
      if (badge) badge.textContent = generatedMode ? "GENERATED (Guidance Hidden)" : "DRAFT (Guidance Visible)";
    }

    function renderPreview(){
      const host = $("previewHost");
      if (!host) return;
      host.innerHTML = renderPreviewHtml();
      updateLikelihoodSummary();
      runChecks();
    }

    function resetAll(){
      fields.forEach(k => { const el = $(k); if (el) el.value = ""; });

      // Defaults
      $("runsTotal").value = "5";
      $("runsIssue").value = "1";
      $("consequenceLevel").value = "3";

      setMode(false);

      // Demo prefill for convenience
      $("sutName").value = GUIDANCE.sutName;
      $("coiPrimary").value = GUIDANCE.coiPrimary;
      $("coiOther").value = GUIDANCE.coiOther;

      renderPreview();
    }

    function saveToDocxDemo(){
      const previewHtml = $("previewHost") ? $("previewHost").innerHTML : "";

      const doc =
`<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>OPCON Export</title>
<style>
  body{ font-family: "Times New Roman", Times, serif; }
  .page{ width: ${esc(getComputedStyle(document.documentElement).getPropertyValue("--page-w").trim() || "8.5in")}; }
  .margins{ padding: ${esc(getComputedStyle(document.documentElement).getPropertyValue("--margin").trim() || "1in")}; }
  .sect{ max-width: ${esc(getComputedStyle(document.documentElement).getPropertyValue("--usable-w").trim() || "6.5in")}; }
</style>
</head>
<body>
  <div class="page">
    <div class="margins">
      ${previewHtml}
    </div>
  </div>
</body>
</html>`;

      const blob = new Blob([doc], { type: "application/msword" });

      const d = getForm();
      const fname = (d.refId || "OPCON") + ".doc";
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fname.replace(/[^\w.\-]+/g, "_");
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 500);
    }

    function goBack(){
      window.location.href = "./index.html";
    }

    function wireEvents(){
      $("btnBack")?.addEventListener("click", (e) => { e.preventDefault(); goBack(); });

      $("btnGenerate")?.addEventListener("click", (e) => {
        e.preventDefault();
        setMode(true);
        renderPreview();
      });

      $("btnReset")?.addEventListener("click", (e) => {
        e.preventDefault();
        resetAll();
      });

      $("btnSave")?.addEventListener("click", (e) => {
        e.preventDefault();
        saveToDocxDemo();
      });

      // Advisory checks update while typing; preview stays stable until Generate
      ["p1","p2","p3","p4","p5","p6"].forEach(id => {
        $(id)?.addEventListener("input", () => { runChecks(); });
        $(id)?.addEventListener("change", () => { runChecks(); });
      });

      // Risk inputs update summary + checks; preview does not auto-generate text
      ["runsTotal","runsIssue","consequenceLevel"].forEach(id => {
        $(id)?.addEventListener("change", () => { updateLikelihoodSummary(); runChecks(); renderPreview(); });
      });

      // COI changes reflect in preview only when generated; but safe to re-render for demo
      ["coiPrimary","coiOther","sutName","refId","date"].forEach(id => {
        $(id)?.addEventListener("change", renderPreview);
      });
    }

    function init(){
      setMode(false);
      $("sutName").value = GUIDANCE.sutName;
      $("coiPrimary").value = GUIDANCE.coiPrimary;
      $("coiOther").value = GUIDANCE.coiOther;

      updateLikelihoodSummary();
      renderPreview();
      wireEvents();
      runChecks();
    }

    init();
  })();
  </script>
</body>
</html>
