<!--
  File: /docs/blue-sheet-demo.html
  Blue Sheet Builder (Demo) — Updated & Heavily Labeled
  --------------------------------------------------------------------
  PURPOSE (Demo):
    - Show how a user fills structured “data blocks” and generates a standards-shaped Blue Sheet.
    - Guidance text is shown first (pink italics + black example context).
    - Preview does NOT change while typing.
    - When the user clicks "Generate Preview", guidance disappears and user input replaces it.

  KEY FEATURES IMPLEMENTED:
    1) Back-to-Flow Diagrams button restored to the ORIGINAL location:
       - Global page header (top band), right-aligned.
    2) Risk Matrix (Figure X) appears AFTER Paragraph 5 in the preview:
       - Only the selected cell is colored (Red/Yellow/Green based on computed risk).
       - Grid lines are grey.
       - TEIN + PM mitigation letter displayed in selected cell (e.g., TEIN-DEMO-M).
       - Figure numbering supports Para 2 figure: if user attaches a figure, it becomes Figure 1; risk matrix becomes Figure 2.
    3) Risk cube:
       - Centered horizontally
       - Width constrained (default 3.0in; adjustable via --risk-w)
    4) Para 2 figure upload:
       - Includes a “sample location” preview and actual file upload workflow.
       - Uploaded image appears inside Para 2 section in the generated preview.
    5) Save to DOCX:
       - Uses a minimal client-side HTML->DOCX approach via Word-compatible HTML (.doc).
       - This is suitable for a demo POC; full build can migrate to a true .docx library/template.
    6) Tense/format indicators:
       - Lightweight checks + visual indicators for each paragraph.
       - Uses browser spellcheck on textareas.
       - Checks are advisory (non-blocking).

  NOTES:
    - This file is self-contained (no external CSS/JS required).
    - Link back assumes flow diagrams page is /docs/index.html. Adjust if needed.

  CHANGE SUMMARY (31 Dec 2025 / 01 Jan 2026):
    - Paragraph 2 split into three separate input blocks (2a/2b/2c) for authoring.
    - GENERATED preview stitches 2a + 2b + 2c into a single Paragraph 2 body (NO 2a/2b/2c labels).
    - Paragraph 2 title does NOT include "(*)".
-->

<!--
  File: /docs/blue-sheet-demo.html
  Blue Sheet Builder (Demo) — Event Workspace + Multi-Draft Saving (via DDT CaseStore)
  --------------------------------------------------------------------
  PURPOSE (Demo):
    - Fill structured data blocks and generate a standards-shaped Blue Sheet preview.
    - Guidance text is shown first and remains visible while typing.
    - Preview does NOT change while typing.
    - Clicking "Generate Preview" hides guidance and uses user input.

  DRAFT SAVING (UPDATED):
    - Uses DDT.createCaseStore() Event Workspace model (localStorage-backed in POC)
    - One Event can contain many documents:
        BlueSheet-001, BlueSheet-002, ...
    - Autosave drafts while user types/changes fields
    - Restore last active doc on load
    - Save on navigation and page hide
    - Figure image data is NOT persisted (metadata only)

  LINKAGE:
    - Flow context may be imported via postMessage and stored locally (separate key).
    - Store can also capture flow context later, but for this demo we keep your
      existing “Imported Flow Context” banner (proof of linkage).

  DEPENDENCIES:
    - Will attempt to load /docs/js/state/caseStore.js (classic script).
    - If missing, the page still runs, but drafts will not persist across reload.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blue Sheet Builder (Demo)</title>

  <style>
    :root{
      --border: rgba(0,0,0,.14);
      --muted: rgba(0,0,0,.65);
      --ink: #111;
      --guidance: #FF33CC;
      --gridline: rgba(0,0,0,.35);

      --risk-low:  #2f7a3e;
      --risk-med:  #c79100;
      --risk-high: #a21724;

      --page-w: 8.5in;
      --page-h: 11in;
      --margin: 1in;
      --usable-w: 6.5in;
      --risk-w: 3.0in;

      --ui-max: 1180px;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      color: var(--ink);
      background: #fff;
    }

    header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }
    .header-left{ flex: 1 1 auto; min-width: 0; }
    .header-right{ flex: 0 0 auto; padding-top: 2px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; }

    header h1 { margin: 0 0 6px; font-size: 16px; }
    header p  { margin: 0; color: var(--muted); font-size: 12.5px; line-height: 1.35; }

    .contextline{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(0,0,0,.70);
      padding: 6px 10px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 10px;
      background: #fafafa;
    }

    .btn-link{
      border: 1px solid var(--border);
      background: #f7f7f7;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .wrap { max-width: var(--ui-max); margin: 0 auto; padding: 16px 18px; }
    .grid { display: grid; grid-template-columns: 460px 1fr; gap: 14px; align-items: start; }
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
      header{ position: static; }
    }

    .card { border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: #fff; }
    .card h2 { margin: 0; font-size: 14px; }
    .hr { border-top: 1px solid var(--border); margin: 12px 0; }

    label { display: block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    input, select, textarea {
      width: 100%; box-sizing: border-box;
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px; font-size: 13px; background: #fff;
    }
    textarea { min-height: 86px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    .btnbar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button {
      border: 1px solid var(--border);
      background: #f7f7f7; border-radius: 10px;
      padding: 10px 12px; font-size: 13px; cursor: pointer;
    }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button.danger  { background: #fff; border-color: rgba(155,17,30,.35); color: #7c0c16; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 8px; background: #fafafa; }

    .subhdr{
      margin: 14px 0 6px;
      padding: 8px 10px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 10px;
      background: #fbfbfb;
      font-size: 12.5px;
      font-weight: 700;
      color: rgba(0,0,0,.78);
    }

    .guidance {
      font-style: italic;
      color: var(--guidance);
      font-size: 12.5px;
      line-height: 1.35;
      margin: 6px 0 8px;
    }
    .context {
      font-size: 12.5px;
      line-height: 1.35;
      color: rgba(0,0,0,.78);
      margin: 6px 0 10px;
    }

    .modebar {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px dashed rgba(0,0,0,.18);
      border-radius: 12px;
      background: #fbfbfb;
      margin-bottom: 10px;
      font-size: 12.5px;
      color: rgba(0,0,0,.75);
      line-height: 1.35;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
    }

    .savepill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      font-size: 12px;
      color: rgba(0,0,0,.72);
      white-space: nowrap;
    }

    .preview { font-family: "Times New Roman", Times, serif; }
    .paper {
      width: min(100%, var(--page-w));
      margin: 0 auto;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .paper-inner{
      padding: var(--margin);
    }

    .topline { text-align: center; font-weight: 700; }
    .subline { text-align: center; margin-top: 2px; }
    .meta { display:flex; justify-content: space-between; margin: 10px 0 14px; font-size: 12px; }
    .sect { margin: 12px 0; max-width: var(--usable-w); }
    .sect h3 { margin: 0 0 6px; font-size: 14px; }
    .sect p  { margin: 0 0 8px; font-size: 13px; line-height: 1.35; }
    .mini { font-size: 12px; margin-top: 6px; }
    .muted { color: rgba(0,0,0,.65); }

    .p2-subtitle{
      margin: 8px 0 6px;
      font-size: 13px;
      font-weight: 700;
    }

    .figure-box{
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
      margin: 10px 0 0;
    }
    .figure-cap{
      font-size: 12px;
      color: rgba(0,0,0,.75);
      margin-top: 6px;
      line-height: 1.25;
    }
    .figure-img{
      width: 100%;
      max-width: var(--usable-w);
      display: block;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
    }

    .risk-wrap{
      margin-top: 10px;
      max-width: var(--usable-w);
    }
    .risk-title{
      font-size: 12.5px;
      margin: 6px 0 8px;
      line-height: 1.25;
    }
    .risk-center{
      display:flex;
      justify-content:center;
    }
    .risk-cube{
      width: var(--risk-w);
      border: 1px solid var(--gridline);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    .risk-grid{
      display:grid;
      grid-template-columns: 44px repeat(5, 1fr);
      grid-template-rows: 34px repeat(5, 1fr);
    }
    .risk-cell{
      border-right: 1px solid var(--gridline);
      border-bottom: 1px solid var(--gridline);
      padding: 6px 6px;
      font-size: 10.5px;
      line-height: 1.15;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:#fff;
      min-height: 34px;
    }
    .risk-cell.head{
      font-size: 10px;
      color: rgba(0,0,0,.75);
      background: #f7f7f7;
      font-weight: 600;
    }
    .risk-cell.axis{
      background: #f7f7f7;
      font-weight: 600;
      color: rgba(0,0,0,.75);
    }

    .risk-selected.low   { background: rgba(47,122,62,.18); outline: 2px solid rgba(47,122,62,.6); }
    .risk-selected.med   { background: rgba(199,145,0,.20); outline: 2px solid rgba(199,145,0,.65); }
    .risk-selected.high  { background: rgba(162,23,36,.16); outline: 2px solid rgba(162,23,36,.65); }
    .risk-selected .tag  { font-weight: 700; }

    .checks{
      margin-top: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fafafa;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(0,0,0,.75);
    }
    .checkline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .checkline:last-child{ border-bottom: none; }
    .status{
      font-weight: 700;
      white-space: nowrap;
    }
    .ok{ color: #147a2d; }
    .warn{ color: #b17400; }
    .bad{ color: #b00020; }

    .tiny-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .tiny-row .mini-pill{
      padding: 8px 10px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 10px;
      background:#fafafa;
      font-size: 12px;
      color: rgba(0,0,0,.75);
      line-height:1.25;
    }

    @media print {
      header, .left, .btnbar { display: none !important; }
      .wrap { padding: 0; }
      .card { border: none; }
      .paper{ border:none; border-radius:0; }
      body { margin: 0; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-row">
      <div class="header-left">
        <h1>Blue Sheet Builder (Demo)</h1>
        <p>
          Guidance is shown first and remains visible while you type.
          Select <span class="kbd">Generate Preview</span> to replace guidance with your entered content.
          Drafts save under a single Event and can be switched.
        </p>
        <div id="flowContextLine" class="contextline" hidden></div>
      </div>

      <div class="header-right">
        <button id="btnNewDocTop" class="btn-link" type="button" title="Create a new Blue Sheet draft under this event">New Blue Sheet</button>

        <select id="docPickerTop" class="btn-link" title="Open an existing Blue Sheet draft" style="padding:10px 12px;">
          <option value="">Open Draft…</option>
        </select>

        <button id="btnBackToFlowTop" class="btn-link" type="button">Back to Flow Diagrams</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">

      <div class="card left">
        <h2>Inputs</h2>
        <div class="hr"></div>

        <div class="tiny-row">
          <div class="mini-pill"><strong>Event:</strong> <span id="eventPill">Not set</span></div>
          <div class="mini-pill"><strong>Document:</strong> <span id="docPill">Not set</span></div>
        </div>

        <div class="hr"></div>

        <div>
          <label for="sampleSelect">Demo selection</label>
          <select id="sampleSelect">
            <option value="mfd" selected>MFD Example (Office Copier / Printer / Scanner)</option>
            <option value="lcac">LCAC Example (Alternate Template Sample)</option>
            <option value="custom">Custom (manual entry)</option>
          </select>
          <div class="hint">Demo mode controls guidance/example blocks. Your inputs remain separate per document.</div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label for="tein">TEIN</label>
            <input id="tein" placeholder="TEIN-DEMO" />
          </div>
          <div>
            <label for="issueNo">Issue #</label>
            <input id="issueNo" placeholder="001" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="rev">Revision</label>
            <input id="rev" placeholder="0" />
          </div>
          <div>
            <label for="date">Date (DD Mmm YYYY)</label>
            <input id="date" placeholder="27 Dec 2025" />
          </div>
        </div>

        <div class="hr"></div>
        <div>
          <label for="sutName">SUT name</label>
          <input id="sutName" placeholder="Network Multifunction Device (MFD)" />
        </div>

        <div class="hr"></div>
        <div class="hint">Inputs for Paragraphs 1–5 remain blank until you enter data. Guidance stays on the right until you generate.</div>

        <div style="margin-top:10px;">
          <label for="p1Problem">1. Problem / Issue (past tense, one sentence)</label>
          <textarea id="p1Problem" spellcheck="true" placeholder=""></textarea>
        </div>

        <div class="row3" style="margin-top:10px;">
          <div>
            <label for="riskC">Consequence (1–5)</label>
            <select id="riskC">
              <option value="1">1</option><option value="2">2</option>
              <option value="3" selected>3</option><option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div>
            <label for="riskL">Likelihood (1–5)</label>
            <select id="riskL">
              <option value="1">1</option><option value="2">2</option>
              <option value="3" selected>3</option><option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div>
            <label for="pmMit">PM mitigation (H/M/L)</label>
            <select id="pmMit">
              <option value="High">High</option>
              <option value="Moderate" selected>Moderate</option>
              <option value="Low">Low</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="coiPrimary">Primary COI</label>
            <input id="coiPrimary" placeholder="S-7, Training / Supportability" />
          </div>
          <div>
            <label for="coiOther">Other COI(s)</label>
            <input id="coiOther" placeholder="C-3, Network Integration" />
          </div>
        </div>

        <div class="hr"></div>
        <div class="subhdr">Paragraph 2 (Split): 2a / 2b / 2c</div>

        <div>
          <label for="p2a">2a. Establish the Test Conditions (past tense)</label>
          <textarea id="p2a" spellcheck="true" placeholder=""></textarea>
          <div class="hint">1–2 sentences. Frame what testing/vignette/task/subtask was being conducted when the issue was discovered.</div>
        </div>

        <div style="margin-top:10px;">
          <label for="p2b">2b. Present Data (past tense)</label>
          <textarea id="p2b" spellcheck="true" placeholder=""></textarea>
          <div class="hint">Standalone evidence. Include results (quant/qual), and any workaround (objective, third-person).</div>
        </div>

        <div style="margin-top:10px;">
          <label for="p2c">2c. Analyze/Evaluate the Data (past tense)</label>
          <textarea id="p2c" spellcheck="true" placeholder=""></textarea>
          <div class="hint">What the data indicate and the operational impact. Include before/after workaround effects if applicable.</div>
        </div>

        <div style="margin-top:10px;">
          <label for="p2Figure">Paragraph 2 Figure (optional upload)</label>
          <input id="p2Figure" type="file" accept="image/*" />
          <div class="hint">
            Upload an image to demonstrate insertion into Paragraph 2. If present, it becomes <span class="kbd">Figure 1</span>.
            The risk matrix becomes <span class="kbd">Figure 2</span>.
            <br><strong>Note:</strong> for the demo, the uploaded image data is not persisted across reload.
          </div>
        </div>

        <div class="hr"></div>

        <div>
          <label for="p3">3. Mission Relation (future tense, 1–2 sentences)</label>
          <textarea id="p3" spellcheck="true" placeholder=""></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="p4">4. Mitigation Assessment (present tense)</label>
          <textarea id="p4" spellcheck="true" placeholder=""></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="p5">5. Conclusion (present tense; up to 3 sentences preferred)</label>
          <textarea id="p5" spellcheck="true" placeholder=""></textarea>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="recommendation">6. Recommendation</label>
            <select id="recommendation">
              <option>Correct prior to IOT&amp;E.</option>
              <option selected>Correct as soon as possible.</option>
              <option>Correct to achieve full mission capability.</option>
            </select>
          </div>
          <div>
            <label for="sheetType">Sheet type</label>
            <select id="sheetType">
              <option selected>Blue Sheet</option>
              <option>Gold Sheet (Demo label only)</option>
            </select>
          </div>
        </div>

        <div class="btnbar">
          <button class="primary" id="btnGenerate" type="button">Generate Preview</button>
          <button id="btnReset" type="button">Reset</button>
          <button id="btnSave" type="button">Save to DOCX</button>
        </div>

        <div class="hint">
          Drafts autosave under the current <span class="kbd">Event</span> and <span class="kbd">Document</span>.
          Use <span class="kbd">New Blue Sheet</span> to create the next sequential draft and <span class="kbd">Open Draft</span> to switch.
        </div>

        <div class="checks" id="checksPanel" aria-label="Tense and format checks">
          <div style="font-weight:700; margin-bottom:6px;">Advisory Checks (Demo)</div>
          <div class="checkline"><span>Paragraph 1: past tense + one sentence + ends with period</span><span id="chkP1" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Paragraph 2a: past tense (advisory)</span><span id="chkP2a" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Paragraph 2b: past tense (advisory)</span><span id="chkP2b" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Paragraph 2c: past tense (advisory)</span><span id="chkP2c" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Paragraph 3: future tense (use “will”)</span><span id="chkP3" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Paragraph 4: present tense (use “is/are”)</span><span id="chkP4" class="status warn">CHECK</span></div>
          <div class="checkline"><span>Paragraph 5: present tense (advisory)</span><span id="chkP5" class="status warn">CHECK</span></div>
        </div>
      </div>

      <div class="card preview">
        <div class="modebar" id="modebar">
          <div>
            <span class="badge" id="modeBadge">DRAFT (Guidance Visible)</span>
            <span style="margin-left:8px;" id="figureNote" class="muted"></span>
          </div>
          <div class="muted">
            <span class="savepill" id="saveStatus">Not saved</span>
          </div>
        </div>

        <div class="paper" id="paper">
          <div class="paper-inner" id="previewHost"></div>
        </div>

        <div class="hint muted" style="margin-top:10px;">
          Note: “Save to DOCX” exports Word-compatible HTML (.doc) for demo purposes. Full build can generate true DOCX from an official template.
        </div>
      </div>

    </div>
  </div>

  <!-- Load shared store if present -->
  <script src="./js/state/caseStore.js"></script>

  <script>
  (function () {
    const $ = (id) => document.getElementById(id);

    /* =========================
       FLOW CONTEXT IMPORT (kept)
       ========================= */
    const FLOW_CTX_KEY = "blueSheetDemo::flowContext::v1";

    function setFlowContextLine(ctx) {
      const el = $("flowContextLine");
      if (!el) return;
      if (!ctx) { el.hidden = true; el.textContent = ""; return; }

      const pack = ctx?.meta?.packId || "-";
      const step = ctx?.meta?.nodeId || "-";
      const title = ctx?.currentNode?.title || "";
      el.textContent = `Imported Flow Context: Pack ${pack} | Step ${step}${title ? " | " + title : ""}`;
      el.hidden = false;
    }

    function loadSavedFlowContext() {
      try {
        const raw = localStorage.getItem(FLOW_CTX_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function saveFlowContext(ctx) {
      try { localStorage.setItem(FLOW_CTX_KEY, JSON.stringify(ctx)); } catch {}
    }

    window.addEventListener("message", (ev) => {
      const msg = ev?.data;
      if (!msg || msg.type !== "DDT_FLOW_CONTEXT") return;
      saveFlowContext(msg.payload);
      setFlowContextLine(msg.payload);
      // Optional future: auto-populate certain fields from msg.payload
    });

    /* =========================================================
       EVENT WORKSPACE + DOC DRAFTS (NEW PRIMARY SAVE MECHANISM)
       ========================================================= */

    // Decide an eventId in a deterministic way:
    // 1) query param event=...
    // 2) if present, TEIN value
    // 3) fallback "TEIN-DEMO"
    function getQueryParam(name) {
      try { return new URLSearchParams(location.search).get(name); } catch { return null; }
    }

    function normalizeEventId(s) {
      const raw = String(s || "").trim();
      if (!raw) return "";
      return raw.replace(/[^\w.\-]+/g, "_").slice(0, 80);
    }

    // If DDT store exists, use it. Otherwise, run without persistence.
    const HAS_STORE = !!(window.DDT && typeof window.DDT.createCaseStore === "function");
    const store = HAS_STORE ? window.DDT.createCaseStore() : null;

    let eventId = "";
    let docId = "";
    let generatedMode = false;

    // Debounce + checkpoint
    let dirty = false;
    let saveTimer = null;
    let checkpointTimer = null;
    let lastSavedAt = null;

    function setSaveStatus(text) {
      const el = $("saveStatus");
      if (el) el.textContent = text;
    }
    function fmtTime(iso) {
      if (!iso) return "";
      try { return new Date(iso).toLocaleString(); } catch { return ""; }
    }

    function updatePills() {
      const e = $("eventPill");
      const d = $("docPill");
      if (e) e.textContent = eventId || "Not set";
      if (d) d.textContent = docId || "Not set";
    }

    function rebuildDocPicker() {
      const sel = $("docPickerTop");
      if (!sel) return;

      // Keep first option
      const first = sel.options[0];
      sel.innerHTML = "";
      sel.appendChild(first);

      if (!HAS_STORE || !eventId) return;

      const docs = store.listDocuments().filter(x => (x.docType || "").toLowerCase() === "bluesheet");
      for (const d of docs) {
        const opt = document.createElement("option");
        opt.value = d.id;
        const status = (d.status || "DRAFT").toUpperCase();
        opt.textContent = `${d.id} (${status})`;
        sel.appendChild(opt);
      }

      // Keep selection aligned
      if (docId) sel.value = docId;
    }

    function ensureWorkspaceInitialized() {
      // event priority: query param -> current TEIN -> default
      const qEvent = normalizeEventId(getQueryParam("event"));
      const teinVal = normalizeEventId(($("tein")?.value || "").trim());
      eventId = qEvent || teinVal || "TEIN-DEMO";

      if (HAS_STORE) {
        store.initEvent(eventId, eventId);
        const ws = store.getEvent();
        if (ws.activeDocId) docId = ws.activeDocId;
      }

      updatePills();
      rebuildDocPicker();
    }

    function createNewBlueSheetDoc() {
      ensureWorkspaceInitialized();
      if (!HAS_STORE) {
        alert("Store module not available. Ensure ./js/state/caseStore.js exists under /docs.");
        return;
      }
      const created = store.createDocument("BlueSheet", {
        title: "Blue Sheet Draft"
      });
      docId = created.id;
      store.setActiveDocument(docId);
      updatePills();
      rebuildDocPicker();

      // Seed issueNo from sequential docId (BlueSheet-XYZ)
      const seq = String(docId).split("-")[1] || "";
      if ($("issueNo")) $("issueNo").value = seq || $("issueNo").value;

      // Seed TEIN from eventId if blank
      if ($("tein") && !String($("tein").value || "").trim()) $("tein").value = eventId;

      // Reset figure state (per doc)
      p2FigureDataUrl = null;
      p2FigureName = null;
      if ($("p2Figure")) $("p2Figure").value = "";

      // Reset generated mode for new doc
      setMode(false);

      // Persist immediately
      dirty = true;
      saveDraftNow("new-doc");

      // Render
      renderPreview();
      runAdvisoryChecks();
    }

    function openDoc(id) {
      if (!HAS_STORE) return;
      ensureWorkspaceInitialized();

      const doc = store.getDocument(id);
      if (!doc) return;

      docId = id;
      store.setActiveDocument(docId);

      // Load fields into UI
      applyDraftFields(doc.fields || {});

      // Restore generatedMode (stored in fields)
      setMode(!!(doc.fields && doc.fields.__generatedMode));

      // Restore figure metadata only
      p2FigureDataUrl = null; // image data not persisted
      p2FigureName = (doc.fields && doc.fields.__p2FigureName) ? String(doc.fields.__p2FigureName) : null;
      if ($("p2Figure")) $("p2Figure").value = ""; // user must re-upload

      updatePills();
      rebuildDocPicker();

      dirty = false;
      lastSavedAt = doc.updatedAt || null;
      setSaveStatus(lastSavedAt ? ("Restored " + fmtTime(lastSavedAt)) : "Restored");

      renderPreview();
      runAdvisoryChecks();
    }

    function saveDraftNow(reason) {
      if (!HAS_STORE) {
        // Without store, we still behave, but indicate non-persistence.
        dirty = false;
        lastSavedAt = new Date().toISOString();
        setSaveStatus("Saved (no persistence) " + fmtTime(lastSavedAt));
        return;
      }

      ensureWorkspaceInitialized();
      if (!docId) {
        // First save: create a doc if none exists yet
        const created = store.createDocument("BlueSheet", { title: "Blue Sheet Draft" });
        docId = created.id;
        store.setActiveDocument(docId);
        updatePills();
        rebuildDocPicker();
        const seq = String(docId).split("-")[1] || "";
        if ($("issueNo") && !String($("issueNo").value || "").trim()) $("issueNo").value = seq;
      }

      const payload = buildDraftFieldsPayload();
      store.updateDocumentFields(docId, payload);

      // Also store a small doc-level patch (optional metadata)
      store.updateDocument(docId, {
        title: `${payload.tein || eventId}-${payload.issueNo || ""}`.replace(/\-+$/,"")
      });

      dirty = false;
      lastSavedAt = new Date().toISOString();
      setSaveStatus("Saved " + fmtTime(lastSavedAt));
    }

    function markDirty() {
      dirty = true;
      setSaveStatus("Saving…");
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveDraftNow("debounce"), 900);
    }

    function startCheckpointAutosave() {
      if (checkpointTimer) clearInterval(checkpointTimer);
      checkpointTimer = setInterval(() => { if (dirty) saveDraftNow("checkpoint"); }, 20000);
    }

    function saveOnPageExit() {
      if (dirty) saveDraftNow("page-exit");
    }

    /* =========================
       FORM FIELDS + PAYLOAD
       ========================= */

    const fields = [
      "tein","issueNo","rev","date","sutName",
      "p1Problem","riskC","riskL","pmMit",
      "coiPrimary","coiOther",
      "p2a","p2b","p2c",
      "p3","p4","p5",
      "recommendation","sheetType",
      "sampleSelect"
    ];

    function getForm() {
      const d = {};
      fields.forEach(k => d[k] = ($(k)?.value || "").trim());
      return d;
    }

    function applyDraftFields(saved) {
      // Populate UI from saved fields
      if (!saved) return;
      fields.forEach(k => {
        const el = $(k);
        if (!el) return;
        if (saved[k] !== undefined && saved[k] !== null) el.value = String(saved[k]);
      });

      // Ensure SUT seed if empty
      if ($("sutName") && !String($("sutName").value || "").trim()) {
        const demoKey = ($("sampleSelect")?.value || "mfd");
        $("sutName").value = (GUIDANCE[demoKey]?.sutName || GUIDANCE.mfd.sutName);
      }
    }

    function buildDraftFieldsPayload() {
      const d = getForm();
      // Store doc-specific internal fields with __ prefix
      d.__generatedMode = !!generatedMode;
      d.__p2FigureName = p2FigureName || null;
      d.__flowCtx = loadSavedFlowContext() || null;
      d.__savedAt = new Date().toISOString();
      return d;
    }

    /* =========================
       RISK + GUIDANCE + PREVIEW
       ========================= */

    function esc(s) {
      return (s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    function para(text) {
      const parts = (text || "").split(/\n\s*\n/).map(t => t.trim()).filter(Boolean);
      return parts.map(p => `<p>${esc(p)}</p>`).join("");
    }

    function riskBandFromCL(c, l) {
      const v = c * l;
      if (v <= 6) return "Low";
      if (v <= 14) return "Medium";
      return "High";
    }
    function riskClassFromBand(band) {
      if (band === "Low") return "low";
      if (band === "Medium") return "med";
      return "high";
    }
    function pmMitLetter(pm) {
      const x = (pm || "").toLowerCase();
      if (x.startsWith("h")) return "H";
      if (x.startsWith("l")) return "L";
      return "M";
    }

    const GUIDANCE = {
      mfd: {
        sutName: "Network Multifunction Device (MFD) — Office Copier/Printer/Scanner (Network + USB)",
        p1: { g: `Paragraph 1, Problem or Issue Description (past tense).`, x: "The Network Multifunction Device (MFD) experienced intermittent failures to complete Scan-to-Network jobs to approved network destinations during operational use." },
        p2a:{ g:`2a — Establish the Test Conditions (past tense):`, x:"The MFD’s ability to print from a networked workstation, scan to approved network destinations, scan to a directly connected workstation, and perform copy operations was assessed during routine office operations over a five-day period using standard user accounts, approved network shares, and mixed document types." },
        p2b:{ g:`2b — Present Data (past tense):`, x:"Scan-to-Network failures occurred in 9 of 50 scan attempts and resulted in job termination with an on-panel error message and no file written to the destination share. In 6 of the 9 failed attempts, users repeated the scan job without modifying settings and achieved successful completion on a subsequent attempt. As a workaround, users performed Scan-to-PC via USB connection and manually transferred files to the network, increasing task steps and time to completion." },
        p2c:{ g:`2c — Analyze/Evaluate the Data (past tense):`, x:"The data indicated that the MFD’s Scan-to-Network function reliability was inconsistent under normal operational loads. While a workaround existed, the workaround increased user workload, introduced additional opportunities for error, and reduced confidence that scanned products were reliably captured and distributed." },
        p3: { g:`Paragraph 3, Mission Relation (future tense).`, x:"During routine administrative document processing, intermittent Scan-to-Network failures will delay dissemination of scanned products and increase the likelihood of incomplete or misrouted documentation, resulting in degraded office workflow and delayed completion of time-sensitive administrative actions." },
        p4: { g:`Paragraph 4, Mitigation Assessment (present tense).`, x:"Based on coordination with the system administrator and vendor support, the technical solution is being investigated... It is assessed there is a moderate possibility Scan-to-Network reliability will not be fully corrected prior to the next test event." },
        p5: { g:`Paragraph 5, Conclusion (present tense).`, x:"The MFD’s intermittent failures to complete Scan-to-Network jobs are of moderate consequence and moderate likelihood to occur... If this risk is unmitigated, it will potentially be a Major 3 deficiency." }
      },
      lcac: {
        sutName: "Landing Craft Air Cushion (LCAC) — Demonstration Alternate Example",
        p1:{ g:`Paragraph 1, Problem or Issue Description (past tense).`, x:"The LCAC experienced intermittent loss of navigation display updates during high-vibration operations." },
        p2a:{ g:`2a — Establish the Test Conditions (past tense):`, x:"The LCAC’s navigation subsystem was assessed during a mission profile including transit, approach, and beaching evolutions in Sea State 3 conditions." },
        p2b:{ g:`2b — Present Data (past tense):`, x:"During multiple high-vibration segments, the navigation display intermittently stopped updating... required the operator to cycle display power to restore updates." },
        p2c:{ g:`2c — Analyze/Evaluate the Data (past tense):`, x:"The data indicated the navigation display update reliability was inconsistent... elevated crew workload and reduced margin for error during maneuvering." },
        p3:{ g:`Paragraph 3, Mission Relation (future tense).`, x:"During high-demand maneuvering, intermittent loss of navigation display updates will increase crew workload and delay corrective action, resulting in degraded navigation safety and reduced confidence in maneuver execution." },
        p4:{ g:`Paragraph 4, Mitigation Assessment (present tense).`, x:"The vendor and maintenance activity are evaluating display update loss conditions... moderate possibility the display update loss will not be fully corrected prior to the next operational event." },
        p5:{ g:`Paragraph 5, Conclusion (present tense).`, x:"The LCAC’s intermittent loss of navigation display updates is of moderate consequence... If unmitigated, the risk will potentially be categorized as a Major 3 deficiency." }
      }
    };

    function guidanceBlock(g, x) {
      return `<div class="guidance">${esc(g)}</div><div class="context">${para(x)}</div>`;
    }

    function renderPara2Generated(d, p2FigureHtml) {
      const a = (d.p2a || "").trim();
      const b = (d.p2b || "").trim();
      const c = (d.p2c || "").trim();
      const combined = [a, b, c].filter(Boolean).join("\n\n");
      const bodyHtml = combined ? para(combined) : `<p class="muted">[Paragraph 2 not entered]</p>`;
      return `${bodyHtml}${p2FigureHtml || ""}`;
    }

    function renderPara2Draft(gset, p2FigureHtml) {
      return `
        <div class="p2-subtitle">2a. Establish the Test Conditions.</div>
        ${guidanceBlock(gset.p2a.g, gset.p2a.x)}
        <div class="p2-subtitle">2b. Present Data.</div>
        ${guidanceBlock(gset.p2b.g, gset.p2b.x)}
        ${p2FigureHtml}
        <div class="p2-subtitle">2c. Analyze/Evaluate the Data.</div>
        ${guidanceBlock(gset.p2c.g, gset.p2c.x)}
      `;
    }

    function renderRiskMatrix(d, figureNumber) {
      const c = parseInt(d.riskC || "3", 10);
      const l = parseInt(d.riskL || "3", 10);
      const band = riskBandFromCL(c, l);
      const cls  = riskClassFromBand(band);

      // Use TEIN + PM mitigation letter, as you had
      const teinTag = `${esc(d.tein || eventId || "TEIN")}-${pmMitLetter(d.pmMit)}`;
      const title = `Figure ${figureNumber}. ${band} Risk (Selected: C${c} x L${l})`;

      let html = `
        <div class="risk-wrap">
          <div class="risk-title"><strong>${esc(title)}</strong></div>
          <div class="risk-center">
            <div class="risk-cube" role="img" aria-label="Risk matrix">
              <div class="risk-grid">
      `;

      html += `<div class="risk-cell head"></div>`;
      for (let cx = 1; cx <= 5; cx++) html += `<div class="risk-cell head">C${cx}</div>`;

      for (let ly = 5; ly >= 1; ly--) {
        html += `<div class="risk-cell axis">L${ly}</div>`;
        for (let cx = 1; cx <= 5; cx++) {
          const isSelected = (cx === c && ly === l);
          const selectedClass = isSelected ? `risk-selected ${cls}` : "";
          const cellText = isSelected ? `<span class="tag">${teinTag}</span>` : "";
          html += `<div class="risk-cell ${selectedClass}">${cellText}</div>`;
        }
      }

      html += `
              </div>
            </div>
          </div>
        </div>
      `;
      return html;
    }

    let p2FigureDataUrl = null;
    let p2FigureName = null;

    async function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function onFigureChange() {
      const input = $("p2Figure");
      const file = input && input.files ? input.files[0] : null;
      if (!file) {
        p2FigureDataUrl = null;
        p2FigureName = null;
        renderPreview();
        markDirty();
        return;
      }
      p2FigureName = file.name || "figure";
      p2FigureDataUrl = await fileToDataUrl(file);
      renderPreview();
      markDirty();
    }

    function renderPreviewHtml() {
      const d = getForm();

      const pendingRiskNo = `${esc(d.tein || eventId || "TEIN")}-${esc(d.issueNo || "001")} (Rev ${esc(d.rev || "0")})`;

      const hasP2Figure = !!p2FigureDataUrl;
      const riskFigureNumber = hasP2Figure ? 2 : 1;

      const riskTag = `((${esc(d.riskC || "3")}x${esc(d.riskL || "3")}) ${esc(d.pmMit || "Moderate")})`;

      const demoKey = ($("sampleSelect")?.value || "mfd");
      const gset = GUIDANCE[demoKey] || GUIDANCE.mfd;

      const sutLine = generatedMode ? esc(d.sutName || gset.sutName) : esc(gset.sutName);

      const p1Body = generatedMode
        ? (d.p1Problem ? `<p>${esc(d.p1Problem)} ${riskTag}</p>` : `<p class="muted">[Paragraph 1 not entered]</p>`)
        : (guidanceBlock(gset.p1.g, `${gset.p1.x} ${riskTag}`));

      let p2FigureHtml = "";
      if (hasP2Figure) {
        p2FigureHtml = `
          <div class="figure-box">
            <img class="figure-img" src="${p2FigureDataUrl}" alt="Uploaded figure for Paragraph 2" />
            <div class="figure-cap"><strong>Figure 1.</strong> ${esc(p2FigureName || "Uploaded figure")}</div>
          </div>
        `;
      } else if (!generatedMode) {
        const figName = p2FigureName ? `Last saved figure: <strong>${esc(p2FigureName)}</strong> (re-upload required)` : "No figure saved.";
        p2FigureHtml = `
          <div class="figure-box">
            <div class="muted" style="font-size:12px;">
              <strong>[Sample Figure Location]</strong> If a figure is uploaded for Paragraph 2, it will appear here as <strong>Figure 1</strong>.
              The risk matrix will then be labeled <strong>Figure 2</strong>.<br/>
              ${figName}
            </div>
          </div>
        `;
      }

      const p2Body = generatedMode ? renderPara2Generated(d, p2FigureHtml) : renderPara2Draft(gset, p2FigureHtml);

      const p3Body = generatedMode ? (d.p3 ? para(d.p3) : `<p class="muted">[Paragraph 3 not entered]</p>`) : guidanceBlock(gset.p3.g, gset.p3.x);
      const p4Body = generatedMode ? (d.p4 ? para(d.p4) : `<p class="muted">[Paragraph 4 not entered]</p>`) : guidanceBlock(gset.p4.g, gset.p4.x);
      const p5Body = generatedMode ? (d.p5 ? para(d.p5) : `<p class="muted">[Paragraph 5 not entered]</p>`) : guidanceBlock(gset.p5.g, gset.p5.x);

      const riskMatrix = renderRiskMatrix(d, riskFigureNumber);
      const p6Body = `<p>${esc(d.recommendation || "Correct as soon as possible.")}</p>`;

      const dateLine = esc(d.date || "DD Mmm YYYY");
      const coiPrimary = esc(d.coiPrimary || "");
      const coiOther = esc(d.coiOther || "");

      return `
        <div class="topline">DRAFT</div>
        <div class="subline"><strong>COMMANDER, OPERATIONAL TEST AND EVALUATION FORCE</strong></div>
        <div class="subline"><strong>PENDING RISK NO.</strong> ${pendingRiskNo}</div>
        <div class="subline"><strong>${esc(d.sheetType || "Blue Sheet")}</strong></div>

        <div class="meta">
          <div><span class="muted">Date:</span> ${dateLine}</div>
          <div><span class="muted">SUT:</span> ${sutLine}</div>
        </div>

        <div class="sect">
          <h3>1. SYSTEM UNDER TEST PENDING RISK.</h3>
          ${p1Body}
          <div class="mini">
            <div><span class="muted">a. Primary COI:</span> ${coiPrimary}</div>
            <div><span class="muted">b. Other COI(s):</span> ${coiOther}</div>
            <div><span class="muted">c. Previously Identified:</span> No.</div>
          </div>
        </div>

        <div class="sect">
          <h3>2. TEST CONDITIONS, RESULTS, AND ANALYSIS.</h3>
          ${p2Body}
        </div>

        <div class="sect">
          <h3>3. MISSION RELATION.</h3>
          ${p3Body}
        </div>

        <div class="sect">
          <h3>4. MITIGATION ASSESSMENT FOR INITIAL OPERATIONAL TEST AND EVALUATION (IOT&amp;E).</h3>
          ${p4Body}
        </div>

        <div class="sect">
          <h3>5. CONCLUSION.</h3>
          ${p5Body}
          ${riskMatrix}
        </div>

        <div class="sect">
          <h3>6. RECOMMENDATION.</h3>
          ${p6Body}
        </div>
      `;
    }

    function setMode(isGenerated) {
      generatedMode = !!isGenerated;
      const badge = $("modeBadge");
      const note = $("figureNote");

      if (generatedMode) { if (badge) badge.textContent = "GENERATED (Guidance Hidden)"; }
      else { if (badge) badge.textContent = "DRAFT (Guidance Visible)"; }

      const hasP2Figure = !!p2FigureDataUrl;
      const riskFig = hasP2Figure ? 2 : 1;
      if (note) {
        note.textContent = hasP2Figure
          ? `Para 2 includes Figure 1. Risk Matrix is Figure ${riskFig}.`
          : `No Para 2 figure. Risk Matrix is Figure ${riskFig}.`;
      }
    }

    function renderPreview() {
      const host = $("previewHost");
      if (!host) return;
      host.innerHTML = renderPreviewHtml();
      runAdvisoryChecks();
    }

    /* =========================
       ADVISORY CHECKS (unchanged)
       ========================= */

    function setCheck(id, level, label) {
      const el = $(id);
      if (!el) return;
      el.classList.remove("ok","warn","bad");
      el.classList.add(level);
      el.textContent = label;
    }

    function isOneSentence(s) {
      const t = (s || "").trim();
      if (!t) return false;
      const matches = t.match(/[.!?]/g) || [];
      return matches.length === 1;
    }

    function looksPastTense(s) {
      const t = (s || "").toLowerCase();
      if (!t) return false;
      return /(\bwas\b|\bwere\b|\bexperienced\b|\bfailure\b|\bfailed\b|\boccurred\b|\bresulted\b|\bterminated\b|\bassessed\b|\bobserved\b|\brequired\b|\bincreased\b)/.test(t)
        || /\b\w+ed\b/.test(t);
    }

    function looksFutureTense(s) {
      const t = (s || "").toLowerCase();
      if (!t) return false;
      return /\bwill\b/.test(t);
    }

    function looksPresentTense(s) {
      const t = (s || "").toLowerCase();
      if (!t) return false;
      return /(\bis\b|\bare\b|\bhas\b|\bhave\b|\bassess\b|\bbelieve\b|\binclude\b|\bindicate\b)/.test(t);
    }

    function runAdvisoryChecks() {
      const d = getForm();

      const p1 = d.p1Problem;
      if (!p1) setCheck("chkP1","warn","EMPTY");
      else {
        const endsPeriod = p1.trim().endsWith(".");
        const oneSentence = isOneSentence(p1);
        const past = looksPastTense(p1);
        if (endsPeriod && oneSentence && past) setCheck("chkP1","ok","OK");
        else if (past) setCheck("chkP1","warn","REVIEW");
        else setCheck("chkP1","bad","FIX");
      }

      const p2a = d.p2a;
      if (!p2a) setCheck("chkP2a","warn","EMPTY");
      else if (looksPastTense(p2a)) setCheck("chkP2a","ok","OK");
      else setCheck("chkP2a","warn","REVIEW");

      const p2b = d.p2b;
      if (!p2b) setCheck("chkP2b","warn","EMPTY");
      else if (looksPastTense(p2b)) setCheck("chkP2b","ok","OK");
      else setCheck("chkP2b","warn","REVIEW");

      const p2c = d.p2c;
      if (!p2c) setCheck("chkP2c","warn","EMPTY");
      else if (looksPastTense(p2c)) setCheck("chkP2c","ok","OK");
      else setCheck("chkP2c","warn","REVIEW");

      const p3 = d.p3;
      if (!p3) setCheck("chkP3","warn","EMPTY");
      else if (looksFutureTense(p3)) setCheck("chkP3","ok","OK");
      else setCheck("chkP3","bad","ADD “WILL”");

      const p4 = d.p4;
      if (!p4) setCheck("chkP4","warn","EMPTY");
      else if (looksPresentTense(p4)) setCheck("chkP4","ok","OK");
      else setCheck("chkP4","warn","REVIEW");

      const p5 = d.p5;
      if (!p5) setCheck("chkP5","warn","EMPTY");
      else if (looksPresentTense(p5)) setCheck("chkP5","ok","OK");
      else setCheck("chkP5","warn","REVIEW");
    }

    /* =========================
       RESET + DOC EXPORT
       ========================= */

    function resetAll() {
      // Reset only the *form fields*; doc remains same docId.
      ["p1Problem","p2a","p2b","p2c","p3","p4","p5","coiPrimary","coiOther"].forEach(id => { if ($(id)) $(id).value = ""; });

      if ($("riskC")) $("riskC").value = "3";
      if ($("riskL")) $("riskL").value = "3";
      if ($("pmMit")) $("pmMit").value = "Moderate";
      if ($("recommendation")) $("recommendation").value = "Correct as soon as possible.";
      if ($("sheetType")) $("sheetType").value = "Blue Sheet";

      // Preserve TEIN / issue / rev / date / sutName unless you want otherwise
      // (This is usually desirable for a batch of sheets in one event.)

      const fig = $("p2Figure");
      if (fig) fig.value = "";
      p2FigureDataUrl = null;
      p2FigureName = null;

      setMode(false);
      renderPreview();

      dirty = true;
      saveDraftNow("reset");
      setSaveStatus("Saved " + fmtTime(lastSavedAt));
    }

    function saveToDocxDemo() {
      const previewHtml = $("previewHost") ? $("previewHost").innerHTML : "";
      const doc =
`<!doctype html><html><head><meta charset="utf-8"><title>Blue Sheet Export</title>
<style>
  body{ font-family: "Times New Roman", Times, serif; }
  .page{ width: ${esc(getComputedStyle(document.documentElement).getPropertyValue("--page-w").trim() || "8.5in")}; }
  .margins{ padding: ${esc(getComputedStyle(document.documentElement).getPropertyValue("--margin").trim() || "1in")}; }
  .sect{ max-width: ${esc(getComputedStyle(document.documentElement).getPropertyValue("--usable-w").trim() || "6.5in")}; }
</style></head><body><div class="page"><div class="margins">${previewHtml}</div></div></body></html>`;
      const blob = new Blob([doc], { type: "application/msword" });

      const d = getForm();
      const fname = (d.tein || eventId || "TEIN") + "-" + (d.issueNo || "000") + "-BlueSheet.doc";
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fname.replace(/[^\w.\-]+/g, "_");
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 500);
    }

    function goBackToFlow() {
      saveOnPageExit();
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: "BLUE_SHEET_BACK" }, "*");
          return;
        }
      } catch {}
      window.location.href = "./index.html";
    }

    /* =========================
       WIRING
       ========================= */

    function applyQueryString() {
      const params = new URLSearchParams(window.location.search);
      const sample = (params.get("sample") || "").toLowerCase();
      if (sample === "mfd" || sample === "lcac") {
        const sel = $("sampleSelect");
        if (sel) sel.value = sample;
      }
    }

    function seedDefaultsIfBlank() {
      const demoKey = ($("sampleSelect")?.value || "mfd");
      if ($("sutName") && !String($("sutName").value || "").trim()) $("sutName").value = (GUIDANCE[demoKey]?.sutName || GUIDANCE.mfd.sutName);
      if ($("tein") && !String($("tein").value || "").trim()) $("tein").value = eventId || "TEIN-DEMO";
    }

    function wireEvents() {
      $("btnBackToFlowTop")?.addEventListener("click", (e) => { e.preventDefault(); goBackToFlow(); });

      $("btnNewDocTop")?.addEventListener("click", (e) => { e.preventDefault(); createNewBlueSheetDoc(); });

      $("docPickerTop")?.addEventListener("change", (e) => {
        const id = String(e.target.value || "");
        if (!id) return;
        openDoc(id);
      });

      $("sampleSelect")?.addEventListener("change", () => { setMode(generatedMode); renderPreview(); markDirty(); });

      $("p2Figure")?.addEventListener("change", async () => { try { await onFigureChange(); } catch(e) { console.error(e); } });

      $("btnGenerate")?.addEventListener("click", (e) => { e.preventDefault(); setMode(true); renderPreview(); markDirty(); });
      $("btnReset")?.addEventListener("click", (e) => { e.preventDefault(); resetAll(); });
      $("btnSave")?.addEventListener("click", (e) => { e.preventDefault(); saveToDocxDemo(); });

      // markDirty on edits
      const watch = ["p1Problem","p2a","p2b","p2c","p3","p4","p5","riskC","riskL","pmMit",
                     "tein","issueNo","rev","date","sutName","coiPrimary","coiOther","recommendation","sheetType"];
      watch.forEach(id => {
        $(id)?.addEventListener("input", () => { runAdvisoryChecks(); markDirty(); });
        $(id)?.addEventListener("change", () => { runAdvisoryChecks(); renderPreview(); markDirty(); });
      });

      window.addEventListener("pagehide", saveOnPageExit);
      document.addEventListener("visibilitychange", () => { if (document.visibilityState === "hidden") saveOnPageExit(); });
    }

    /* =========================
       INIT
       ========================= */

    function init() {
      applyQueryString();
      setMode(false);

      // Restore saved flow context display (if any)
      setFlowContextLine(loadSavedFlowContext());

      // Initialize workspace early (so pills show immediately)
      ensureWorkspaceInitialized();
      seedDefaultsIfBlank();
      updatePills();

      // If store exists, prefer restoring active doc.
      if (HAS_STORE) {
        const ws = store.getEvent();
        docId = ws.activeDocId || "";

        rebuildDocPicker();

        // If there is an active doc, open it.
        if (docId) {
          openDoc(docId);
        } else {
          // If there are any existing BlueSheets, open the first; else create first
          const docs = store.listDocuments().filter(x => (x.docType || "").toLowerCase() === "bluesheet");
          if (docs.length) openDoc(docs[0].id);
          else createNewBlueSheetDoc();
        }
      } else {
        // No store; run without persistence but still functional
        setSaveStatus("Not saved (store missing)");
        // Seed SUT name
        const demoKey = ($("sampleSelect")?.value || "mfd");
        $("sutName").value = GUIDANCE[demoKey]?.sutName || GUIDANCE.mfd.sutName;
      }

      renderPreview();
      wireEvents();
      runAdvisoryChecks();
      startCheckpointAutosave();

      if (!lastSavedAt) setSaveStatus(HAS_STORE ? "Saved state ready" : "Not saved (store missing)");
    }

    init();
  })();
  </script>
</body>
</html>
