<!-- File: /docs/demo.html
     Updates requested:
     1) "Back to Flow Diagrams" moved to top-right of the PREVIEW header area.
     2) Risk matrix centered left-to-right and reduced by ~0.5" (3.5in -> 3.0in).
     3) Para 2 figure upload UI added (file picker + filename). In Preview:
        - If figure enabled + file chosen: render the image + caption.
        - If figure enabled + no file: render a placeholder box + caption.
     4) Draft mode still shows guidance; preview changes only when Generate Preview is clicked.
     5) Save DOCX remains (image is shown in preview; DOCX demo still writes the figure title line only).
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blue Sheet Builder (Demo)</title>
  <style>
    :root{
      --border: rgba(0,0,0,.14);
      --muted: rgba(0,0,0,.65);
      --ink: #111;
      --guidance: #FF33CC; /* RGB(255,51,204) */
      --ok: #0b6b2c;
      --warn: #a35b00;
      --bad: #9b111e;

      /* Print geometry */
      --page-w: 8.5in;
      --page-h: 11in;
      --margin: 1in;
      --usable-w: 6.5in;  /* 8.5 - 2*1 */
      --risk-w: 3.0in;    /* WAS 3.5in; now ~0.5in smaller */
    }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: var(--ink); }
    header { padding: 16px 18px; border-bottom: 1px solid var(--border); background: #fff; position: sticky; top: 0; z-index: 10; }
    header h1 { margin: 0 0 6px; font-size: 18px; }
    header p { margin: 0; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 16px 18px; }
    .grid { display: grid; grid-template-columns: 460px 1fr; gap: 14px; align-items: start; }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } header{ position: static; } }

    .card { border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: #fff; }
    .card h2 { margin: 0; font-size: 14px; }
    .hr { border-top: 1px solid var(--border); margin: 12px 0; }

    label { display: block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    input, select, textarea {
      width: 100%; box-sizing: border-box;
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px; font-size: 13px; background: #fff;
    }
    textarea { min-height: 86px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    .btnbar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button {
      border: 1px solid var(--border);
      background: #f7f7f7; border-radius: 10px;
      padding: 10px 12px; font-size: 13px; cursor: pointer;
    }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button.danger { background: #fff; border-color: rgba(155,17,30,.35); color: #7c0c16; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 8px; background: #fafafa; }

    /* Guidance blocks */
    .guidance {
      font-style: italic;
      color: var(--guidance);
      font-size: 12.5px;
      line-height: 1.35;
      margin: 6px 0 8px;
    }
    .context {
      font-size: 12.5px;
      line-height: 1.35;
      color: rgba(0,0,0,.78);
      margin: 6px 0 10px;
    }

    /* Mode banner */
    .modebar {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px dashed rgba(0,0,0,.18);
      border-radius: 12px;
      background: #fbfbfb;
      margin-bottom: 10px;
      font-size: 12.5px;
      color: rgba(0,0,0,.75);
      line-height: 1.35;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
    }

    /* QA */
    .qa {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fafafa;
      font-size: 12.5px;
      line-height: 1.35;
    }
    .qa .line { display:flex; justify-content: space-between; gap: 10px; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,.06); }
    .qa .line:last-child { border-bottom: none; }
    .qa .k { color: rgba(0,0,0,.75); }
    .qa .v { font-weight: 600; }
    .qa .ok { color: var(--ok); }
    .qa .warn { color: var(--warn); }
    .qa .bad { color: var(--bad); }

    .qa-tag {
      display: inline-block;
      margin-left: 6px;
      padding: 1px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 11px;
      vertical-align: middle;
    }

    /* Preview */
    .preview { font-family: "Times New Roman", Times, serif; }
    .sheet {
      width: var(--usable-w);
      max-width: 100%;
      margin: 0 auto;
    }
    .topline { text-align: center; font-weight: 700; }
    .subline { text-align: center; margin-top: 2px; }
    .meta { display:flex; justify-content: space-between; margin: 10px 0 14px; font-size: 12px; gap: 12px; flex-wrap: wrap; }
    .sect { margin: 12px 0; }
    .sect h3 { margin: 0 0 6px; font-size: 14px; }
    .sect p { margin: 0 0 8px; font-size: 13px; line-height: 1.35; }
    .mini { font-size: 12px; margin-top: 6px; }
    .muted { color: rgba(0,0,0,.65); }

    .preview-note {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(0,0,0,.65);
      line-height: 1.35;
    }

    /* Preview header row (right card) */
    .preview-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* Figure placeholder for Para 2 */
    .figure-block {
      width: var(--usable-w);
      max-width: 100%;
      margin: 8px 0 0;
    }
    .figure-box {
      width: 100%;
      border: 1px solid rgba(0,0,0,.25);
      border-radius: 8px;
      padding: 10px;
      background: #fff;
      box-sizing: border-box;
      font-size: 12px;
      color: rgba(0,0,0,.7);
    }
    .figure-box.placeholder {
      border-style: dashed;
      background: #fafafa;
    }
    .figure-cap {
      margin-top: 6px;
      font-size: 12px;
      color: rgba(0,0,0,.75);
    }
    .figure-img {
      width: 100%;
      height: auto;
      display: block;
      border: 1px solid rgba(0,0,0,.22);
      border-radius: 8px;
      background: #fff;
    }

    /* Risk matrix */
    .risk-figure {
      margin-top: 10px;
    }
    .risk-title {
      font-size: 12.5px;
      margin: 0 0 6px;
      color: rgba(0,0,0,.8);
    }
    .risk-wrap {
      width: var(--risk-w);
      max-width: 100%;
      margin: 0 auto;         /* CENTER LEFT-TO-RIGHT */
    }
    .risk-grid {
      width: 100%;
      aspect-ratio: 1 / 1;
      display: grid;
      grid-template-columns: repeat(6, 1fr); /* left labels + 5 cells */
      grid-template-rows: repeat(6, 1fr);    /* top labels + 5 cells */
      border: 1px solid rgba(0,0,0,.35);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    .rg-cell {
      border-right: 1px solid rgba(0,0,0,.25);
      border-bottom: 1px solid rgba(0,0,0,.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: rgba(0,0,0,.75);
      background: #fff;
      box-sizing: border-box;
      padding: 2px;
      text-align: center;
      line-height: 1.1;
    }
    .rg-head { background: #fafafa; font-weight: 700; color: rgba(0,0,0,.75); }
    .rg-axis { background: #fafafa; font-weight: 700; color: rgba(0,0,0,.75); }

    /* Selected cell gets color only */
    .sel-low   { background: rgba(0, 140, 60, .18); color: #0b6b2c; font-weight: 700; }
    .sel-med   { background: rgba(255, 193, 7, .25); color: #7a4a00; font-weight: 700; }
    .sel-high  { background: rgba(220, 53, 69, .18); color: #8a0f1a; font-weight: 700; }

    /* Hide guidance in Preview mode */
    body.preview-mode .guidance { display: none !important; }
    body.preview-mode .mode-draft-only { display: none !important; }

    /* Print: (kept minimal; DOCX is primary output) */
    @media print {
      header, .left, .btnbar, .modebar, .preview-head button { display: none !important; }
      .wrap { padding: 0; }
      .card { border: none; }
      body { margin: 0; }
      .sheet { width: var(--usable-w); }
    }
  </style>
</head>

<body>
<header>
  <h1>Blue Sheet Builder (Demo)</h1>
  <p>
    Draft mode shows template guidance (pink italics). Preview is generated only when you select
    <span class="kbd">Generate Preview</span>. Saving produces a DOCX file.
  </p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Authoring -->
    <div class="card left">
      <h2>Authoring</h2>

      <div class="modebar">
        <div>
          <span class="badge" id="modeBadge">Mode: Draft</span>
          <span class="badge" id="previewStatus">Preview: Not generated</span>
        </div>
        <div class="hint" style="margin:0;">
          Navigation moved to the Preview header (right panel).
        </div>
      </div>

      <div class="row">
        <div>
          <label for="tein">TEIN</label>
          <input id="tein" placeholder="DEMO" value="DEMO" />
        </div>
        <div>
          <label for="issueNo">Issue #</label>
          <input id="issueNo" placeholder="001" value="001" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="rev">Revision</label>
          <input id="rev" placeholder="0" value="0" />
        </div>
        <div>
          <label for="date">Date (DD Mmm YYYY)</label>
          <input id="date" placeholder="27 Dec 2025" value="27 Dec 2025" />
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <label for="sutName">SUT name</label>
        <input id="sutName" placeholder="Network Multifunction Device (MFD)" value="Network Multifunction Device (MFD)" />
      </div>

      <div class="hr"></div>

      <!-- Risk selection -->
      <div class="row3">
        <div>
          <label for="riskC">Consequence (1–5)</label>
          <select id="riskC">
            <option value="1">1</option><option value="2">2</option>
            <option value="3" selected>3</option><option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div>
          <label for="riskL">Likelihood (1–5)</label>
          <select id="riskL">
            <option value="1">1</option><option value="2">2</option>
            <option value="3" selected>3</option><option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div>
          <label for="pmMit">PM mitigation (H/M/L)</label>
          <select id="pmMit">
            <option value="High">High</option>
            <option value="Moderate" selected>Moderate</option>
            <option value="Low">Low</option>
          </select>
        </div>
      </div>

      <div class="hint">
        Risk matrix is rendered in Preview only. The matrix itself is centered and capped at <span class="kbd">3.0 inches</span> wide.
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label for="coiPrimary">Primary COI</label>
          <input id="coiPrimary" placeholder="S-7, Training / Supportability" value="S-7, Training / Supportability" />
        </div>
        <div>
          <label for="coiOther">Other COI(s)</label>
          <input id="coiOther" placeholder="C-3, Network Integration" value="C-3, Network Integration" />
        </div>
      </div>

      <div class="hr"></div>

      <!-- Paragraphs with guidance + MFD context -->
      <div class="sect">
        <label for="p1Problem">1. Problem statement (past tense; one sentence)
          <span class="qa-tag" id="qaP1">QA: —</span>
        </label>
        <div class="guidance" id="gP1">
          This paragraph is a concise description of the problem or issue, written in the past tense. The reader must clearly understand what the problem is with the System Under Test (SUT). Only one problem or issue shall be addressed per Blue or Gold Sheet.<br><br>
          The problem statement should be written as a single sentence and should not include discussion of operational impact. Operational impact is addressed in the Mission Relation paragraph.<br><br>
          The problem described in this paragraph must be stated consistently in the Mission Relation (paragraph 3) and Conclusion (paragraph 5). Take care to use the same terminology and context in each paragraph.<br><br>
          Include the assessed risk categorization using the consequence-by-likelihood format followed by the Program Manager mitigation assessment (High, Moderate, or Low), for example ((3x2) Moderate).
        </div>
        <div class="context">
          <strong>MFD context:</strong> The SUT is a network-capable multifunction device used for printing, scanning, copying, and basic maintenance functions in both networked and direct-connect configurations.
        </div>
        <textarea id="p1Problem" placeholder="(Leave blank for demo; enter a real observed issue when ready.)"></textarea>
      </div>

      <div class="sect">
        <label for="p2">2. Test Conditions, Results, and Analysis (past tense)
          <span class="qa-tag" id="qaP2">QA: —</span>
        </label>
        <div class="guidance" id="gP2">
          This paragraph establishes the technical and operational basis for the issue and is written entirely in the past tense.<br><br>
          Begin this paragraph by establishing the test conditions under which the problem was observed. Describe the mission, vignette, task, or subtask being performed when the issue occurred. Identify what was being evaluated and how the evaluation was conducted.<br><br>
          Following the test condition description, present only the data and results directly related to the problem. Data may be quantitative or qualitative. The Blue or Gold Sheet must stand alone and shall not reference external analysis memoranda.<br><br>
          Figures, tables, screenshots, or photographs may be included if they clarify the results. Annotate figures using the same wording used in the paragraph text to ensure clarity for the reader.<br><br>
          If a workaround was employed, describe how the workaround was used and its effect on task execution, operator workload, and mission performance.<br><br>
          Conclude this paragraph with analysis and evaluation of the data. Explain what the data indicate regarding consequence and likelihood. This analysis must logically support the Mission Relation in paragraph 3.
        </div>
        <div class="context">
          <strong>MFD context:</strong> Operational use includes printing from a networked workstation, scanning to approved network destinations, scanning to a directly connected workstation, copying, and routine maintenance actions such as toner, drum, and fuser replacement.
        </div>

        <!-- Para 2 figure option + upload UI -->
        <div class="mode-draft-only" style="margin: 8px 0 10px;">
          <label style="display:flex; gap:10px; align-items:center; font-size: 12.5px; color: rgba(0,0,0,.75);">
            <input type="checkbox" id="p2HasFigure" />
            Include a figure/table in Paragraph 2
          </label>

          <div id="p2FigureControls" style="margin-top:10px; display:none;">
            <div class="row">
              <div>
                <label for="p2FigureFile">Figure Upload (demo)</label>
                <input id="p2FigureFile" type="file" accept="image/png,image/jpeg,image/jpg" />
                <div class="hint" id="p2FigureFileHint" style="margin-top:6px;">
                  No file selected. In Preview, a placeholder figure will be shown unless a file is chosen.
                </div>
              </div>
              <div>
                <label for="p2FigureCaption">Figure/Table Caption (optional)</label>
                <input id="p2FigureCaption" placeholder="Figure 1. (example caption)" />
                <div class="hint" style="margin-top:6px;">
                  Preview renders Figure 1 in Paragraph 2 if enabled. Risk matrix becomes Figure 2.
                </div>
              </div>
            </div>
            <div class="hint" style="margin-top:8px;">
              Para 2 content width limit: <span class="kbd">6.5 inches</span>. Image will be scaled to fit.
            </div>
          </div>
        </div>

        <textarea id="p2" placeholder="(Leave blank for demo; enter conditions, results, and analysis when ready.)"></textarea>
      </div>

      <div class="sect">
        <label for="p3">3. Mission Relation (future tense; 1–2 sentences)
          <span class="qa-tag" id="qaP3">QA: —</span>
        </label>
        <div class="guidance" id="gP3">
          This paragraph describes the operational “so what” and is written in the future tense.<br><br>
          The Mission Relation must build directly on the data, results, and analysis presented in paragraph 2. The problem must be stated in the same context and meaning as in paragraph 1.<br><br>
          The Mission Relation should normally be one sentence and should rarely exceed two sentences.<br><br>
          Use the approved boilerplate structure where possible. For example: “During [mission or task], the [problem] will [operational impact], resulting in [mission impact].”
        </div>
        <div class="context">
          <strong>MFD context:</strong> Mission impact may include delayed document dissemination, reduced administrative throughput, or degraded support to operational or staff functions.
        </div>
        <textarea id="p3" placeholder="(Leave blank for demo; enter mission relation when ready.)"></textarea>
      </div>

      <div class="sect">
        <label for="p4">4. Mitigation Assessment (present tense)
          <span class="qa-tag" id="qaP4">QA: —</span>
        </label>
        <div class="guidance" id="gP4">
          This paragraph assesses the Program Manager’s mitigation approach and is written in the present tense.<br><br>
          Address whether the Program Manager is aware of the problem, whether a technical solution exists, whether sufficient time is available to correct or mitigate the problem prior to IOT&amp;E, and whether funding is available.<br><br>
          Discuss the expected effectiveness of any planned mitigation actions and identify any remaining risk.<br><br>
          Conclude this paragraph by assessing the High, Moderate, or Low possibility that the problem will not be corrected or substantially mitigated prior to IOT&amp;E.
        </div>
        <div class="context">
          <strong>MFD context:</strong> Mitigation may include vendor support actions, firmware updates, configuration changes, procedural controls, or user training.
        </div>
        <textarea id="p4" placeholder="(Leave blank for demo; enter mitigation assessment when ready.)"></textarea>
      </div>

      <div class="sect">
        <label for="p5">5. Conclusion (present tense; 3 sentences)
          <span class="qa-tag" id="qaP5">QA: —</span>
        </label>
        <div class="guidance" id="gP5">
          This paragraph is written in the present tense and consists of three distinct sentences.<br><br>
          The first sentence states the assessed consequence and likelihood of the problem.<br><br>
          The second sentence states the assessed possibility that the problem will not be corrected or substantially mitigated prior to IOT&amp;E.<br><br>
          The third sentence states the resulting deficiency level if the problem remains unmitigated and references the Issue Risk Matrix figure.
        </div>
        <div class="context">
          <strong>MFD context:</strong> This paragraph summarizes the operational risk posed by the MFD issue and its potential deficiency classification.
        </div>
        <textarea id="p5" placeholder="(Leave blank for demo; enter conclusion when ready.)"></textarea>
      </div>

      <div class="sect">
        <label for="recommendationText">6. Recommendation (future tense; standardized if possible)
          <span class="qa-tag" id="qaP6">QA: —</span>
        </label>
        <div class="guidance" id="gP6">
          This paragraph provides a recommendation regarding the timing of corrective action and is written in the future tense.<br><br>
          Use one of the standardized recommendation statements provided in the approved template unless a case-specific recommendation is required.<br><br>
          If a case-specific recommendation is used, ensure it is concise, actionable, and directly related to mission conditions.
        </div>
        <div class="context">
          <strong>MFD context:</strong> Recommendations typically address correction prior to IOT&amp;E, as soon as possible, or prior to achieving full mission capability.
        </div>
        <select id="recommendationSelect" class="mode-draft-only">
          <option value="">(Select a standard recommendation)</option>
          <option>Correct prior to IOT&amp;E.</option>
          <option selected>Correct as soon as possible.</option>
          <option>Correct to achieve full mission capability.</option>
        </select>
        <textarea id="recommendationText" placeholder="(Leave blank for demo; you may keep the standard recommendation or write a case-specific one.)"></textarea>
      </div>

      <div class="qa" id="qaPanel">
        <div class="line"><span class="k">QA Summary</span><span class="v" id="qaSummary">—</span></div>
        <div class="line"><span class="k">Spelling</span><span class="v">Browser spellcheck enabled (demo)</span></div>
        <div class="line"><span class="k">Preview updates</span><span class="v">Manual only (Generate Preview)</span></div>
      </div>

      <div class="btnbar">
        <button class="primary" id="btnGenerate">Generate Preview</button>
        <button id="btnBackToDraft">Back to Draft</button>
        <button id="btnSaveDocx">Save DOCX</button>
        <button class="danger" id="btnClear">Clear Inputs</button>
      </div>

      <div class="hint">
        Drafting guidance remains visible while you type. When you generate preview, guidance is removed and only authored content is shown.
      </div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="card preview">
      <div class="preview-head">
        <h2>Generated Preview</h2>
        <button id="btnBackToFlowTop" class="btn">Back to Flow Diagrams</button>
      </div>

      <div id="previewHost">
        <div class="preview-note">Preview has not been generated. Select <span class="kbd">Generate Preview</span> when ready.</div>
      </div>

      <div class="preview-note muted">
        Output reflects 8.5×11 formatting assumptions with 1" margins (6.5" usable width). Risk matrix is capped at 3.0" width and centered.
      </div>
    </div>
  </div>
</div>

<!-- DOCX library (browser): docx -->
<script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/build/index.umd.js"></script>

<script>
(function () {
  const $ = (id) => document.getElementById(id);

  // -----------------------------------------
  // Para 2 figure file state (local only; no server)
  // -----------------------------------------
  let p2FigureFile = null;
  let p2FigureUrl = "";

  function setFigureFile(file) {
    // revoke any previous URL
    if (p2FigureUrl) {
      try { URL.revokeObjectURL(p2FigureUrl); } catch(_) {}
      p2FigureUrl = "";
    }
    p2FigureFile = file || null;
    if (p2FigureFile) {
      p2FigureUrl = URL.createObjectURL(p2FigureFile);
    }
    updateFigureFileHint();
  }

  function updateFigureFileHint() {
    const hint = $("p2FigureFileHint");
    if (!hint) return;
    if (!p2FigureFile) {
      hint.textContent = "No file selected. In Preview, a placeholder figure will be shown unless a file is chosen.";
    } else {
      hint.textContent = `Selected: ${p2FigureFile.name} (Preview will show the image after Generate Preview).`;
    }
  }

  // -----------------------------------------
  // Helpers
  // -----------------------------------------
  function nowStamp() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  function esc(s) {
    return (s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function paras(text, emptyFallback) {
    const t = (text || "").trim();
    if (!t) return `<p><span class="muted">${esc(emptyFallback || "Not provided.")}</span></p>`;
    const parts = t.split(/\n\s*\n/).map(x => x.trim()).filter(Boolean);
    return parts.map(p => `<p>${esc(p)}</p>`).join("");
  }
  function sentenceCount(text) {
    const t = (text || "").trim();
    if (!t) return 0;
    const matches = t.match(/[^.!?]+[.!?]+(\s|$)/g);
    return matches ? matches.length : 1;
  }

  // -----------------------------------------
  // Tense heuristics (demo-grade)
  // -----------------------------------------
  function tenseCheck(text, expected) {
    const t = (text || "").toLowerCase();
    if (!t.trim()) return { level: "warn", msg: "Empty" };

    const hasWill = /\bwill\b/.test(t);
    const hasShall = /\bshall\b/.test(t);
    const hasWasWere = /\b(was|were)\b/.test(t);
    const hasPastEd = /\b\w+ed\b/.test(t);

    if (expected === "past") {
      if (hasWill || hasShall) return { level: "bad", msg: "Likely not past (contains will/shall)" };
      if (!hasWasWere && !hasPastEd) return { level: "warn", msg: "Past tense not obvious" };
      return { level: "ok", msg: "Past cues present" };
    }

    if (expected === "future") {
      if (!(hasWill || hasShall)) return { level: "bad", msg: "Future cue missing (add will/shall)" };
      return { level: "ok", msg: "Future cue present" };
    }

    if (expected === "present") {
      if (hasWill || hasShall) return { level: "warn", msg: "Future cue present (check tense)" };
      return { level: "ok", msg: "No future cue detected" };
    }

    return { level: "warn", msg: "Unknown tense rule" };
  }

  function qaTag(el, res, extra) {
    if (!el) return;
    const cls = res.level === "ok" ? "ok" : (res.level === "bad" ? "bad" : "warn");
    el.classList.remove("ok","warn","bad");
    el.classList.add(cls);
    el.textContent = `QA: ${res.msg}${extra ? " | " + extra : ""}`;
  }

  // -----------------------------------------
  // Risk mapping (demo)
  // -----------------------------------------
  function riskLevel(consequence, likelihood) {
    const c = Number(consequence || 0);
    const l = Number(likelihood || 0);
    const score = c * l;
    if (score <= 4) return "Low";
    if (score <= 12) return "Medium";
    return "High";
  }

  function pmLetter(pmMit) {
    const v = String(pmMit || "").toLowerCase();
    if (v.startsWith("h")) return "H";
    if (v.startsWith("l")) return "L";
    return "M";
  }

  function selectedCellClass(level) {
    if (level === "High") return "sel-high";
    if (level === "Medium") return "sel-med";
    return "sel-low";
  }

  // -----------------------------------------
  // Form state
  // -----------------------------------------
  const fields = [
    "tein","issueNo","rev","date","sutName",
    "riskC","riskL","pmMit",
    "coiPrimary","coiOther",
    "p1Problem","p2","p3","p4","p5",
    "recommendationText"
  ];

  function getForm() {
    const d = {};
    fields.forEach(k => d[k] = ($(`${k}`)?.value || "").trim());
    d.p2HasFigure = !!$("p2HasFigure")?.checked;
    d.p2FigureCaption = ($("p2FigureCaption")?.value || "").trim();
    d.p2FigureFileName = p2FigureFile ? p2FigureFile.name : "";
    d.p2FigureUrl = p2FigureUrl || "";
    d.recommendationSelect = ($("recommendationSelect")?.value || "").trim();
    return d;
  }

  function clearInputs() {
    ["p1Problem","p2","p3","p4","p5","recommendationText"].forEach(id => { if ($(id)) $(id).value = ""; });
    if ($("p2HasFigure")) $("p2HasFigure").checked = false;
    if ($("p2FigureCaption")) $("p2FigureCaption").value = "";
    if ($("p2FigureFile")) $("p2FigureFile").value = "";
    setFigureFile(null);
    toggleP2FigureControls();
  }

  function applyRecommendationDefault() {
    const sel = $("recommendationSelect")?.value || "";
    const txt = $("recommendationText")?.value || "";
    if (!txt.trim() && sel.trim()) $("recommendationText").value = sel.trim();
  }

  // -----------------------------------------
  // Preview rendering
  // -----------------------------------------
  function renderRiskMatrixFigure(figNo, level, d) {
    const c = Number(d.riskC);
    const l = Number(d.riskL);
    const label = `${(d.tein || "TEIN").toUpperCase()}-${pmLetter(d.pmMit)}`;
    const selClass = selectedCellClass(level);

    const cells = [];
    cells.push(`<div class="rg-cell rg-head"></div>`);
    for (let cx=1; cx<=5; cx++){
      cells.push(`<div class="rg-cell rg-head">C${cx}</div>`);
    }
    for (let ly=5; ly>=1; ly--){
      cells.push(`<div class="rg-cell rg-axis">L${ly}</div>`);
      for (let cx=1; cx<=5; cx++){
        const isSel = (cx === c && ly === l);
        const cls = isSel ? `rg-cell ${selClass}` : "rg-cell";
        const txt = isSel ? esc(label) : "";
        cells.push(`<div class="${cls}">${txt}</div>`);
      }
    }

    return `
      <div class="risk-figure figure-block">
        <div class="risk-title"><strong>Figure ${figNo}. ${esc(level)} Risk</strong></div>
        <div class="risk-wrap">
          <div class="risk-grid">
            ${cells.join("")}
          </div>
        </div>
        <div class="figure-cap muted">
          Issue Risk Matrix (grid lines in grey; only the selected cell is colored). Selected cell contains TEIN + PM mitigation modifier (H/M/L).
        </div>
      </div>
    `;
  }

  function renderPara2Figure(figNo, caption, d) {
    const cap = caption || `Figure ${figNo}. (User-provided figure/table inserted in Paragraph 2)`;

    if (d.p2FigureUrl) {
      return `
        <div class="figure-block">
          <img class="figure-img" src="${esc(d.p2FigureUrl)}" alt="Paragraph 2 Figure" />
          <div class="figure-cap"><strong>${esc(cap)}</strong></div>
        </div>
      `;
    }

    // placeholder if no file chosen
    return `
      <div class="figure-block">
        <div class="figure-box placeholder">
          <div><strong>Figure Placeholder</strong></div>
          <div class="muted">No file selected. This placeholder demonstrates where the user-provided figure would appear in Paragraph 2.</div>
        </div>
        <div class="figure-cap"><strong>${esc(cap)}</strong></div>
      </div>
    `;
  }

  function renderPreview(d) {
    const riskLvl = riskLevel(d.riskC, d.riskL);
    const hasP2Fig = !!d.p2HasFigure;
    const riskFigNo = hasP2Fig ? 2 : 1;

    const riskTag = `((${esc(d.riskC)}x${esc(d.riskL)}) ${esc(d.pmMit)})`;
    const pendingRiskNo = `${esc(d.tein)}-${esc(d.issueNo)} (Rev ${esc(d.rev)})`;

    const recText = (d.recommendationText || d.recommendationSelect || "").trim();

    return `
      <div class="sheet">
        <div class="topline">DRAFT</div>
        <div class="subline"><strong>COMMANDER, OPERATIONAL TEST AND EVALUATION FORCE</strong></div>
        <div class="subline"><strong>PENDING RISK NO.</strong> ${pendingRiskNo}</div>
        <div class="subline"><strong>Blue Sheet (Demo)</strong></div>

        <div class="meta">
          <div><span class="muted">Date:</span> ${esc(d.date || "DD Mmm YYYY")}</div>
          <div><span class="muted">SUT:</span> ${esc(d.sutName || "System Under Test")}</div>
        </div>

        <div class="sect">
          <h3>1. SYSTEM UNDER TEST PENDING RISK.</h3>
          <p>${esc(d.p1Problem || "") || '<span class="muted">Not provided.</span>'} ${riskTag}</p>
          <div class="mini">
            <div><span class="muted">a. Primary COI:</span> ${esc(d.coiPrimary || "")}</div>
            <div><span class="muted">b. Other COI(s):</span> ${esc(d.coiOther || "")}</div>
            <div><span class="muted">c. Previously Identified:</span> No.</div>
          </div>
        </div>

        <div class="sect">
          <h3>2. (*) TEST CONDITIONS, RESULTS, AND ANALYSIS.</h3>
          ${paras(d.p2, "Not provided.")}
          ${hasP2Fig ? renderPara2Figure(1, d.p2FigureCaption, d) : ""}
        </div>

        <div class="sect">
          <h3>3. MISSION RELATION.</h3>
          ${paras(d.p3, "Not provided.")}
        </div>

        <div class="sect">
          <h3>4. MITIGATION ASSESSMENT FOR INITIAL OPERATIONAL TEST AND EVALUATION (IOT&amp;E).</h3>
          ${paras(d.p4, "Not provided.")}
        </div>

        <div class="sect">
          <h3>5. CONCLUSION.</h3>
          ${paras(d.p5, "Not provided.")}
          ${renderRiskMatrixFigure(riskFigNo, riskLvl, d)}
        </div>

        <div class="sect">
          <h3>6. RECOMMENDATION.</h3>
          <p>${recText ? esc(recText) : '<span class="muted">Not provided.</span>'}</p>
        </div>
      </div>
    `;
  }

  // -----------------------------------------
  // QA evaluation
  // -----------------------------------------
  function runQA(d) {
    const r1 = tenseCheck(d.p1Problem, "past");
    const r2 = tenseCheck(d.p2, "past");
    const r3 = tenseCheck(d.p3, "future");
    const r4 = tenseCheck(d.p4, "present");
    const r5 = tenseCheck(d.p5, "present");

    const recText = (d.recommendationText || d.recommendationSelect || "").trim();
    const r6 = recText ? tenseCheck(recText, "future") : { level:"warn", msg:"Empty" };

    const p1Sent = sentenceCount(d.p1Problem);
    const p3Sent = sentenceCount(d.p3);
    const p5Sent = sentenceCount(d.p5);

    const p1Extra = p1Sent ? `Sentences: ${p1Sent} (target: 1)` : "Sentences: 0";
    const p3Extra = p3Sent ? `Sentences: ${p3Sent} (target: 1–2)` : "Sentences: 0";
    const p5Extra = p5Sent ? `Sentences: ${p5Sent} (target: 3)` : "Sentences: 0";

    qaTag($("qaP1"), r1, p1Extra);
    qaTag($("qaP2"), r2, null);
    qaTag($("qaP3"), r3, p3Extra);
    qaTag($("qaP4"), r4, null);
    qaTag($("qaP5"), r5, p5Extra);
    qaTag($("qaP6"), r6, null);

    const all = [r1,r2,r3,r4,r5,r6];
    const bad = all.filter(x => x.level === "bad").length;
    const warn = all.filter(x => x.level === "warn").length;

    const summaryEl = $("qaSummary");
    if (summaryEl) {
      if (bad > 0) {
        summaryEl.className = "v bad";
        summaryEl.textContent = `Needs attention (${bad} critical, ${warn} advisory)`;
      } else if (warn > 0) {
        summaryEl.className = "v warn";
        summaryEl.textContent = `Review recommended (${warn} advisory)`;
      } else {
        summaryEl.className = "v ok";
        summaryEl.textContent = "Looks consistent (demo checks)";
      }
    }
  }

  // -----------------------------------------
  // Mode control
  // -----------------------------------------
  function setModePreview(on) {
    document.body.classList.toggle("preview-mode", !!on);
    const badge = $("modeBadge");
    if (badge) badge.textContent = on ? "Mode: Preview" : "Mode: Draft";
  }

  // -----------------------------------------
  // DOCX Save (unchanged behavior; figure image not embedded in demo DOCX)
  // -----------------------------------------
  function buildDocx(d) {
    if (!window.docx) {
      alert("DOCX library failed to load. Check your network connection or CDN access.");
      return null;
    }

    const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = window.docx;

    const riskLvl = riskLevel(d.riskC, d.riskL);
    const hasP2Fig = !!d.p2HasFigure;
    const riskFigNo = hasP2Fig ? 2 : 1;

    const pendingRiskNo = `${(d.tein || "").trim()}-${(d.issueNo || "").trim()} (Rev ${(d.rev || "").trim()})`;
    const riskTag = `((${(d.riskC||"")}x${(d.riskL||"")}) ${(d.pmMit||"")})`;

    const recText = (d.recommendationText || d.recommendationSelect || "").trim();

    function line(text, opts) {
      return new Paragraph({ children: [ new TextRun({ text: text || "" }) ], ...opts });
    }
    function heading(text) {
      return new Paragraph({ text, heading: HeadingLevel.HEADING_3 });
    }
    function bodyParas(text, emptyFallback) {
      const t = (text || "").trim();
      if (!t) return [ line(emptyFallback || "Not provided.", { }) ];
      const parts = t.split(/\n\s*\n/).map(x => x.trim()).filter(Boolean);
      return parts.map(p => line(p));
    }

    const doc = new Document({
      sections: [{
        properties: {
          page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } }
        },
        children: [
          new Paragraph({ children: [ new TextRun({ text: "DRAFT", bold: true }) ], alignment: AlignmentType.CENTER }),
          new Paragraph({ children: [ new TextRun({ text: "COMMANDER, OPERATIONAL TEST AND EVALUATION FORCE", bold: true }) ], alignment: AlignmentType.CENTER }),
          new Paragraph({
            children: [ new TextRun({ text: "PENDING RISK NO. ", bold: true }), new TextRun({ text: pendingRiskNo }) ],
            alignment: AlignmentType.CENTER
          }),
          new Paragraph({ children: [ new TextRun({ text: "Blue Sheet (Demo)", bold: true }) ], alignment: AlignmentType.CENTER }),
          new Paragraph({ text: "" }),

          line(`Date: ${d.date || ""}`),
          line(`SUT: ${d.sutName || ""}`),
          new Paragraph({ text: "" }),

          heading("1. SYSTEM UNDER TEST PENDING RISK."),
          line(`${(d.p1Problem || "Not provided.").trim()} ${riskTag}`),
          line(`a. Primary COI: ${d.coiPrimary || ""}`),
          line(`b. Other COI(s): ${d.coiOther || ""}`),
          line(`c. Previously Identified: No.`),
          new Paragraph({ text: "" }),

          heading("2. (*) TEST CONDITIONS, RESULTS, AND ANALYSIS."),
          ...bodyParas(d.p2, "Not provided."),
          ...(hasP2Fig ? [
            new Paragraph({ text: "" }),
            line(`Figure 1. ${(d.p2FigureCaption || "User-provided figure/table inserted in Paragraph 2").trim()}`),
          ] : []),
          new Paragraph({ text: "" }),

          heading("3. MISSION RELATION."),
          ...bodyParas(d.p3, "Not provided."),
          new Paragraph({ text: "" }),

          heading("4. MITIGATION ASSESSMENT FOR INITIAL OPERATIONAL TEST AND EVALUATION (IOT&E)."),
          ...bodyParas(d.p4, "Not provided."),
          new Paragraph({ text: "" }),

          heading("5. CONCLUSION."),
          ...bodyParas(d.p5, "Not provided."),
          new Paragraph({ text: "" }),
          line(`Figure ${riskFigNo}. ${riskLvl} Risk`),
          line(`(Risk matrix rendered in preview; DOCX demo includes title only.)`),
          new Paragraph({ text: "" }),

          heading("6. RECOMMENDATION."),
          line(recText || "Not provided.")
        ]
      }]
    });

    return { doc, filename: `${(d.tein || "TEIN")}-${(d.issueNo || "ISSUE")}.docx` };
  }

  async function saveDocx(d) {
    const built = buildDocx(d);
    if (!built) return;

    const { doc, filename } = built;
    try {
      const blob = await window.docx.Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 1500);
    } catch (e) {
      console.error(e);
      alert("DOCX save failed. Check console for details.");
    }
  }

  // -----------------------------------------
  // Actions
  // -----------------------------------------
  function generatePreview() {
    applyRecommendationDefault();
    const d = getForm();

    runQA(d);

    setModePreview(true);
    const host = $("previewHost");
    if (host) host.innerHTML = renderPreview(d);

    const status = $("previewStatus");
    if (status) status.textContent = `Preview: Generated at ${nowStamp()}`;
  }

  function backToDraft() {
    setModePreview(false);
    const status = $("previewStatus");
    if (status) status.textContent = "Preview: Not regenerated (draft mode)";
  }

  function applyRecommendationDefault() {
    const sel = $("recommendationSelect")?.value || "";
    const txt = $("recommendationText")?.value || "";
    if (!txt.trim() && sel.trim()) $("recommendationText").value = sel.trim();
  }

  function toggleP2FigureControls() {
    const on = !!$("p2HasFigure")?.checked;
    const wrap = $("p2FigureControls");
    if (wrap) wrap.style.display = on ? "block" : "none";
  }

  // -----------------------------------------
  // Wiring
  // -----------------------------------------
  $("btnGenerate")?.addEventListener("click", (e) => {
    e.preventDefault();
    generatePreview();
  });

  $("btnBackToDraft")?.addEventListener("click", (e) => {
    e.preventDefault();
    backToDraft();
  });

  $("btnSaveDocx")?.addEventListener("click", async (e) => {
    e.preventDefault();
    applyRecommendationDefault();
    const d = getForm();

    if (!document.body.classList.contains("preview-mode")) {
      alert("Generate Preview first (to confirm final content), then Save DOCX.");
      return;
    }
    await saveDocx(d);
  });

  $("btnClear")?.addEventListener("click", (e) => {
    e.preventDefault();
    if (!confirm("Clear paragraph inputs? (Header fields and risk selections remain.)")) return;
    clearInputs();
    runQA(getForm());
    const status = $("previewStatus");
    if (status) status.textContent = "Preview: Not regenerated (inputs cleared)";
  });

  // Top-right navigation (Preview header)
  $("btnBackToFlowTop")?.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = "./index.html";
  });

  // Para 2 figure controls
  $("p2HasFigure")?.addEventListener("change", () => {
    toggleP2FigureControls();
  });

  $("p2FigureFile")?.addEventListener("change", (e) => {
    const file = e.target?.files?.[0] || null;
    setFigureFile(file);
    // NOTE: do NOT regenerate preview automatically; preview changes only on Generate Preview.
  });

  // Keep recommendationText aligned if user picks a standard
  $("recommendationSelect")?.addEventListener("change", () => {
    const txt = $("recommendationText")?.value || "";
    const sel = $("recommendationSelect")?.value || "";
    if (!txt.trim() && sel.trim()) $("recommendationText").value = sel.trim();
  });

  // Initialize
  toggleP2FigureControls();
  updateFigureFileHint();
  runQA(getForm());
  setModePreview(false);

})();
</script>
</body>
</html>
