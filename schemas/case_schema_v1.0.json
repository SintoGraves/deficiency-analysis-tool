{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/case_schema_v1.0.json",
  "title": "Deficiency Analysis Case Schema v1.0",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "case_id",
    "case_status",
    "timestamps",
    "test_context",
    "deficiency_observation",
    "analysis_state",
    "decision_trace",
    "reporting"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0"
    },

    "case_id": {
      "type": "string",
      "minLength": 6,
      "maxLength": 64,
      "description": "Unique case identifier. Recommend a deterministic format (e.g., YYYYMMDD-LOC-ITEM-####)."
    },

    "case_status": {
      "type": "string",
      "enum": ["IN_PROGRESS", "READY_FOR_REVIEW", "CLOSED", "VOIDED"]
    },

    "classification_marking": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "banner": { "type": "string", "default": "UNCLASSIFIED" },
        "portion_marking_required": { "type": "boolean", "default": false },
        "notes": { "type": "string" }
      }
    },

    "timestamps": {
      "type": "object",
      "additionalProperties": false,
      "required": ["created_utc", "last_modified_utc"],
      "properties": {
        "created_utc": { "type": "string", "format": "date-time" },
        "last_modified_utc": { "type": "string", "format": "date-time" },
        "closed_utc": { "type": "string", "format": "date-time" }
      }
    },

    "author": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string" },
        "role": { "type": "string" },
        "organization": { "type": "string" },
        "contact": { "type": "string" }
      }
    },

    "test_context": {
      "type": "object",
      "additionalProperties": false,
      "required": ["test_date", "test_location", "test_item", "test_type"],
      "properties": {
        "test_date": { "type": "string", "format": "date" },
        "test_location": { "type": "string", "minLength": 1 },
        "test_item": { "type": "string", "minLength": 1, "description": "System Under Test (SUT) / test item name." },
        "test_type": {
          "type": "string",
          "enum": ["OT", "DT", "OT&E", "FOT&E", "Regression", "Other"]
        },
        "event_id": { "type": "string" },
        "platform_or_config": { "type": "string", "description": "Configuration/build, baseline, variant, SW version, etc." },
        "scenario_or_mission_ref": { "type": "string", "description": "Scenario ID, mission thread, COI reference, etc." },
        "primary_coi": { "type": "string", "description": "Primary Critical Operational Issue (COI) identifier/title." },
        "supported_cois": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        }
      }
    },

    "deficiency_observation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "statement"],
      "properties": {
        "title": { "type": "string", "minLength": 3, "maxLength": 160 },
        "statement": { "type": "string", "minLength": 10, "description": "Observed deficiency statement (factual, concise)." },
        "conditions": { "type": "string", "description": "Operating conditions, environment, system state, etc." },
        "steps_to_reproduce": {
          "type": "array",
          "items": { "type": "string", "minLength": 3 },
          "default": []
        },
        "evidence_references": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "reference"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["Log", "Screenshot", "Video", "DataFile", "Telemetry", "ObserverNote", "Other"]
              },
              "reference": { "type": "string", "minLength": 1 },
              "notes": { "type": "string" }
            }
          },
          "default": []
        },
        "requirement_references": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["source", "identifier"],
            "properties": {
              "source": {
                "type": "string",
                "enum": ["CPD", "CDD", "CONOPS", "CONOP", "TTP", "LCSP", "PMS", "SystemSpec", "Other"]
              },
              "identifier": { "type": "string", "minLength": 1 },
              "excerpt": { "type": "string", "description": "Optional short excerpt; avoid excessive quoting." }
            }
          },
          "default": []
        }
      }
    },

    "analysis_state": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stage"],
      "properties": {
        "stage": {
          "type": "string",
          "enum": [
            "INTAKE",
            "FIGURE1_CLASSIFICATION",
            "FIGURE2_OMF_DETERMINATION",
            "FIGURE3_QUAL_BASELINE",
            "FIGURE4_QUANT_BASELINE",
            "ROLLUP",
            "FIGURE5_BINNING",
            "REPORT_READY"
          ]
        },
        "unlocked": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "figure1": { "type": "boolean", "default": true },
            "figure2": { "type": "boolean", "default": false },
            "figure3": { "type": "boolean", "default": false },
            "figure4": { "type": "boolean", "default": false },
            "rollup": { "type": "boolean", "default": false },
            "figure5": { "type": "boolean", "default": false }
          }
        }
      }
    },

    "decision_trace": {
      "type": "object",
      "additionalProperties": false,
      "required": ["figure1", "figure2"],
      "properties": {
        "figure1": { "$ref": "#/$defs/decisionPackResult" },
        "figure2": { "$ref": "#/$defs/decisionPackResult" },

        "figure3": { "$ref": "#/$defs/decisionPackResult" },
        "figure4": { "$ref": "#/$defs/decisionPackResult" },
        "rollup": { "$ref": "#/$defs/decisionPackResult" },
        "figure5": { "$ref": "#/$defs/decisionPackResult" }
      }
    },

    "results": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "classification": {
          "type": "string",
          "enum": [
            "RECOMMENDATION",
            "SUPPORT_SYSTEM_DEFICIENCY",
            "OPERATIONAL_CONSIDERATION_OPCON",
            "TACTICAL_CONSIDERATION_TACON",
            "REQUIREMENT_RELATED_DEFICIENCY",
            "UNDETERMINED"
          ],
          "default": "UNDETERMINED"
        },

        "failure_type": {
          "type": "string",
          "enum": ["OMF", "FAILURE", "ANNOTATED_ONLY", "UNDETERMINED"],
          "default": "UNDETERMINED"
        },

        "blue_sheet_required": { "type": "boolean", "default": false },
        "blue_sheet_status": {
          "type": "string",
          "enum": ["NOT_APPLICABLE", "DRAFT", "AWAITING_CONCURRENCE", "FINAL"],
          "default": "NOT_APPLICABLE"
        },

        "analysis_method": {
          "type": "string",
          "enum": ["QUALITATIVE", "QUANTITATIVE", "BOTH", "UNDETERMINED"],
          "default": "UNDETERMINED"
        },

        "operational_impact": {
          "type": "string",
          "description": "Placeholder for Figure 3/4 outputs; exact taxonomy defined in v2 when Figures 3/4 are encoded."
        },
        "mission_criticality": {
          "type": "string",
          "description": "Placeholder for Figure 3/4 outputs; exact taxonomy defined in v2 when Figures 3/4 are encoded."
        },

        "primary_coi_bin": {
          "type": "string",
          "description": "Placeholder for Figure 5 output."
        },
        "secondary_coi_bins": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        }
      }
    },

    "reporting": {
      "type": "object",
      "additionalProperties": false,
      "required": ["required_sections", "generated_artifacts"],
      "properties": {
        "required_sections": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "DEFICIENCY_DESCRIPTION",
              "CLASSIFICATION_RATIONALE",
              "OMF_DETERMINATION",
              "RESULTS_PARAGRAPH",
              "BLUE_SHEET",
              "RELIABILITY_AVAILABILITY_TABLES",
              "SEVERITY_ASSESSMENT",
              "ROLLUP_SUMMARY",
              "BINNING_SUMMARY"
            ]
          },
          "default": ["DEFICIENCY_DESCRIPTION", "RESULTS_PARAGRAPH"]
        },
        "generated_artifacts": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifactRecord" },
          "default": []
        },
        "template_versions": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "deficiency_report_docx": { "type": "string" },
            "blue_sheet_docx": { "type": "string" }
          }
        },
        "review_notes": { "type": "string" }
      }
    },

    "attachments": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["filename"],
        "properties": {
          "filename": { "type": "string" },
          "description": { "type": "string" },
          "hash_sha256": { "type": "string" }
        }
      },
      "default": []
    }
  },

  "$defs": {
    "decisionPackResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["pack_id", "pack_version", "status", "trace"],
      "properties": {
        "pack_id": {
          "type": "string",
          "enum": ["FIGURE1", "FIGURE2", "FIGURE3", "FIGURE4", "ROLLUP", "FIGURE5"]
        },
        "pack_version": {
          "type": "string",
          "minLength": 1,
          "description": "Version of the decision pack used (supports reproducibility)."
        },
        "status": {
          "type": "string",
          "enum": ["NOT_STARTED", "IN_PROGRESS", "COMPLETED", "SKIPPED"]
        },
        "entry_node_id": { "type": "string" },
        "exit_node_id": { "type": "string" },

        "trace": {
          "type": "array",
          "description": "Ordered decision history. Each entry is one answered question or one instruction/action node reached.",
          "items": { "$ref": "#/$defs/traceEntry" },
          "default": []
        },

        "outputs": {
          "type": "object",
          "description": "Decision-pack specific outputs. Kept flexible to allow Figure 3â€“5 later without schema-breaking changes.",
          "additionalProperties": true,
          "default": {}
        }
      }
    },

    "traceEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["node_id", "node_type", "timestamp_utc"],
      "properties": {
        "node_id": { "type": "string", "minLength": 1 },
        "node_type": {
          "type": "string",
          "enum": ["QUESTION", "INSTRUCTION", "ACTION"]
        },
        "timestamp_utc": { "type": "string", "format": "date-time" },

        "question_text": { "type": "string" },
        "answer": {
          "type": "string",
          "enum": ["YES", "NO"]
        },

        "instruction_text": { "type": "string" },

        "action": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "enum": [
                "ENABLE_DOC_GENERATION",
                "REQUIRE_BLUE_SHEET",
                "SET_BLUE_SHEET_STATUS",
                "REQUIRE_RM_TABLES",
                "ROUTE_TO_PACK",
                "MARK_CASE_READY",
                "MARK_CASE_CLOSED"
              ]
            },
            "value": { "type": ["string", "boolean", "number", "object", "array", "null"] }
          }
        },

        "rationale_snippets": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        }
      },
      "allOf": [
        {
          "if": { "properties": { "node_type": { "const": "QUESTION" } }, "required": ["node_type"] },
          "then": { "required": ["question_text", "answer"] }
        },
        {
          "if": { "properties": { "node_type": { "const": "INSTRUCTION" } }, "required": ["node_type"] },
          "then": { "required": ["instruction_text"] }
        },
        {
          "if": { "properties": { "node_type": { "const": "ACTION" } }, "required": ["node_type"] },
          "then": { "required": ["action"] }
        }
      ]
    },

    "artifactRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": ["artifact_type", "filename", "generated_utc"],
      "properties": {
        "artifact_type": {
          "type": "string",
          "enum": ["RESULTS_PARAGRAPH_DOCX", "BLUE_SHEET_DOCX", "DEFICIENCY_REPORT_DOCX", "CASE_EXPORT_ZIP"]
        },
        "filename": { "type": "string", "minLength": 1 },
        "generated_utc": { "type": "string", "format": "date-time" },
        "template_version": { "type": "string" },
        "hash_sha256": { "type": "string" },
        "notes": { "type": "string" }
      }
    }
  }
}
